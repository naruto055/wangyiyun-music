# ä»£ç é‡æ„æ€»ç»“ - æ¶ˆé™¤é­”æ³•å€¼

## ğŸ“‹ é‡æ„èƒŒæ™¯

**é—®é¢˜**ï¼šä»£ç ä¸­å­˜åœ¨å¤šå¤„ç¡¬ç¼–ç çš„é­”æ³•å€¼ï¼ˆMagic Numberï¼‰ï¼Œè¿åäº†**DRYï¼ˆDon't Repeat Yourselfï¼‰**å’Œ**KISSï¼ˆKeep It Simple, Stupidï¼‰**åŸåˆ™ã€‚

**è§¦å‘**ï¼šç”¨æˆ·åœ¨ä»£ç å®¡æŸ¥ä¸­å‘ç° `VideoParseServiceImpl.java:81` ä½¿ç”¨äº†é­”æ³•å€¼ `20 * 1024 * 1024`ã€‚

---

## ğŸ” å‘ç°çš„é­”æ³•å€¼

### **é‡æ„å‰çš„é—®é¢˜ä»£ç **

#### 1. VideoParseServiceImpl.java:81
```java
// âŒ ç¡¬ç¼–ç ï¼šé¢„ç•™20MBç©ºé—´
fileValidationService.validateStorageCapacity(20 * 1024 * 1024);
```

#### 2. FileValidationServiceImpl.java:40-45
```java
// âŒ ç¡¬ç¼–ç ï¼šæœ€å¤§æ–‡ä»¶å¤§å°20MB
private static final long MAX_FILE_SIZE = 20 * 1024 * 1024;

// âŒ ç¡¬ç¼–ç ï¼šæ€»å­˜å‚¨å®¹é‡2GB
private static final long TOTAL_CAPACITY = 2L * 1024 * 1024 * 1024;
```

---

## âœ… é‡æ„æ–¹æ¡ˆ

### **Step 1: æ‰©å±• VideoParseConfig é…ç½®ç±»**

**æ–‡ä»¶**: [VideoParseConfig.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)

**æ–°å¢å­—æ®µ**:
```java
/**
 * å•æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰- ç¼“å­˜å€¼
 */
private Long maxFileSizeBytes;

/**
 * æ€»å­˜å‚¨å®¹é‡é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰- ç¼“å­˜å€¼
 */
private Long totalCapacityBytes;
```

**æ–°å¢å·¥å…·æ–¹æ³•**:
```java
/**
 * è§£ææ–‡ä»¶å¤§å°å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°
 * <p>æ”¯æŒæ ¼å¼ï¼š20M, 2GB, 1024Kç­‰</p>
 */
private long parseSize(String sizeStr) {
    // æ”¯æŒ GBã€MB/Mã€KB/K ç­‰å•ä½
    // è‡ªåŠ¨è½¬æ¢ä¸ºå­—èŠ‚æ•°
}
```

**åˆå§‹åŒ–é€»è¾‘**:
```java
@PostConstruct
public void init() {
    // ...

    // è§£ææ–‡ä»¶å¤§å°å’Œå®¹é‡å­—ç¬¦ä¸²ä¸ºå­—èŠ‚æ•°
    this.maxFileSizeBytes = parseSize(maxFileSize);
    this.totalCapacityBytes = parseSize(totalCapacity);

    // è¾“å‡ºé…ç½®ä¿¡æ¯
    log.info("  - æ–‡ä»¶å¤§å°é™åˆ¶ï¼š{} ({} MB)", maxFileSize, maxFileSizeBytes / 1024 / 1024);
    log.info("  - å­˜å‚¨å®¹é‡é™åˆ¶ï¼š{} ({} MB)", totalCapacity, totalCapacityBytes / 1024 / 1024);
}
```

---

### **Step 2: é‡æ„ FileValidationServiceImpl**

**æ–‡ä»¶**: [FileValidationServiceImpl.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/service/impl/FileValidationServiceImpl.java)

**ç§»é™¤ç¡¬ç¼–ç å¸¸é‡**:
```java
// âŒ åˆ é™¤
private static final long MAX_FILE_SIZE = 20 * 1024 * 1024;
private static final long TOTAL_CAPACITY = 2L * 1024 * 1024 * 1024;
```

**ä½¿ç”¨é…ç½®å€¼**:
```java
@Override
public void validateFileSize(long fileSize) {
    // âœ… ä½¿ç”¨é…ç½®ç±»çš„å€¼
    long maxFileSize = config.getMaxFileSizeBytes();

    if (fileSize > maxFileSize) {
        String fileSizeMB = String.format("%.2f", fileSize / 1024.0 / 1024.0);
        String maxSizeMB = String.format("%.2f", maxFileSize / 1024.0 / 1024.0);
        throw new FileValidationException(
            String.format("æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼š%s MBï¼Œæœ€å¤§å…è®¸ %s MB", fileSizeMB, maxSizeMB)
        );
    }
}

@Override
public void validateStorageCapacity(long requiredSize) {
    // âœ… ä½¿ç”¨é…ç½®ç±»çš„å€¼
    long totalCapacity = config.getTotalCapacityBytes();
    long availableSpace = totalCapacity - usedSpace;

    // ...
}
```

---

### **Step 3: é‡æ„ VideoParseServiceImpl**

**æ–‡ä»¶**: [VideoParseServiceImpl.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java)

**é‡æ„å‰**:
```java
// âŒ ç¡¬ç¼–ç 
fileValidationService.validateStorageCapacity(20 * 1024 * 1024);
```

**é‡æ„å**:
```java
// âœ… ä½¿ç”¨é…ç½®å€¼
fileValidationService.validateStorageCapacity(config.getMaxFileSizeBytes());
```

---

## ğŸ“Š é‡æ„æ•ˆæœå¯¹æ¯”

| é¡¹ç›® | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| **é­”æ³•å€¼æ•°é‡** | 3å¤„ç¡¬ç¼–ç  | 0å¤„ âœ… |
| **é…ç½®çµæ´»æ€§** | âŒ ä¿®æ”¹éœ€æ”¹ä»£ç é‡æ–°ç¼–è¯‘ | âœ… ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ |
| **ä»£ç å¯ç»´æŠ¤æ€§** | âŒ åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­ | âœ… ç»Ÿä¸€åœ¨é…ç½®ç±»ç®¡ç† |
| **é”™è¯¯æç¤º** | å›ºå®šæ˜¾ç¤º "20 MB" | âœ… åŠ¨æ€æ˜¾ç¤ºé…ç½®å€¼ |
| **å•å…ƒæµ‹è¯•** | âŒ éš¾ä»¥æµ‹è¯•ä¸åŒé™åˆ¶ | âœ… å¯è½»æ¾æ³¨å…¥é…ç½® |
| **ç¬¦åˆåŸåˆ™** | âŒ è¿åDRY | âœ… ç¬¦åˆDRYã€KISSã€OCP |

---

## ğŸ¯ é…ç½®æ–‡ä»¶ç¤ºä¾‹

**application.yaml**:
```yaml
video:
  parser:
    max-file-size: 20M        # å•æ–‡ä»¶å¤§å°é™åˆ¶
    total-capacity: 2GB       # æ€»å­˜å‚¨å®¹é‡
    temp-path: D:/music-data/temp/
    # ... å…¶ä»–é…ç½®
```

**æ”¯æŒçš„æ ¼å¼**:
- `20M` / `20MB` - 20å…†å­—èŠ‚
- `2GB` - 2åƒå…†å­—èŠ‚
- `1024K` / `1024KB` - 1024åƒå­—èŠ‚

---

## ğŸš€ å¦‚ä½•è°ƒæ•´é™åˆ¶

### **æ–¹å¼1: ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰**

ç¼–è¾‘ `application.yaml`:
```yaml
video:
  parser:
    max-file-size: 50M        # æ”¹ä¸º50MB
    total-capacity: 5GB       # æ”¹ä¸º5GB
```

é‡å¯åº”ç”¨å³å¯ç”Ÿæ•ˆã€‚

### **æ–¹å¼2: ç¯å¢ƒå˜é‡**

```bash
java -jar app.jar \
  --video.parser.max-file-size=50M \
  --video.parser.total-capacity=5GB
```

### **æ–¹å¼3: Profileç¯å¢ƒ**

**application-dev.yaml** (å¼€å‘ç¯å¢ƒ):
```yaml
video:
  parser:
    max-file-size: 100M   # å¼€å‘ç¯å¢ƒå…è®¸æ›´å¤§æ–‡ä»¶
```

**application-prod.yaml** (ç”Ÿäº§ç¯å¢ƒ):
```yaml
video:
  parser:
    max-file-size: 20M    # ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼é™åˆ¶
```

---

## âœ¨ éµå¾ªçš„è®¾è®¡åŸåˆ™

### **1. DRY (Don't Repeat Yourself)**
- âœ… é…ç½®å€¼åªå®šä¹‰ä¸€æ¬¡
- âœ… å¤šå¤„ä½¿ç”¨ç»Ÿä¸€å¼•ç”¨é…ç½®ç±»

### **2. KISS (Keep It Simple, Stupid)**
- âœ… é…ç½®ç®€å•ç›´è§‚ï¼ˆ`20M` vs `20 * 1024 * 1024`ï¼‰
- âœ… ä¿®æ”¹é…ç½®æ— éœ€ç†è§£å­—èŠ‚è®¡ç®—

### **3. OCP (Open-Closed Principle)**
- âœ… å¯¹æ‰©å±•å¼€æ”¾ï¼šæ”¯æŒæ–°çš„å¤§å°å•ä½
- âœ… å¯¹ä¿®æ”¹å°é—­ï¼šè°ƒæ•´é™åˆ¶ä¸éœ€æ”¹ä»£ç 

### **4. SRP (Single Responsibility Principle)**
- âœ… VideoParseConfig ä¸“é—¨è´Ÿè´£é…ç½®ç®¡ç†
- âœ… å„æœåŠ¡ç±»åªå…³æ³¨ä¸šåŠ¡é€»è¾‘

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### **ç¼–è¯‘æµ‹è¯•**
```bash
mvn clean compile -DskipTests
# âœ… BUILD SUCCESS
```

### **è¿è¡Œæµ‹è¯•**
```bash
# å¯åŠ¨åº”ç”¨
java -jar target/wangyiyun-music-0.0.1-SNAPSHOT.jar

# æŸ¥çœ‹æ—¥å¿—ï¼Œåº”çœ‹åˆ°ï¼š
# ğŸ“‹ è§†é¢‘è§£æé…ç½®åŠ è½½å®Œæˆï¼š
#   - æ–‡ä»¶å¤§å°é™åˆ¶ï¼š20M (20 MB)
#   - å­˜å‚¨å®¹é‡é™åˆ¶ï¼š2GB (2048 MB)
```

### **æ¥å£æµ‹è¯•**
```bash
# æµ‹è¯•å¤§æ–‡ä»¶æ‹¦æˆª
curl -X POST http://localhost:8910/api/video/parse \
  -H "Content-Type: application/json" \
  -d '{"videoUrl":"https://www.bilibili.com/video/BV1Yv6EBkEJ3","platform":"BILIBILI"}'

# åº”è¿”å›ï¼ˆé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºå®é™…é…ç½®å€¼ï¼‰ï¼š
# "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼š25.40 MBï¼Œæœ€å¤§å…è®¸ 20.00 MB"
```

---

## ğŸ“ ä»£ç å˜æ›´æ‘˜è¦

| æ–‡ä»¶ | è¡Œæ•°å˜åŒ– | è¯´æ˜ |
|------|---------|------|
| VideoParseConfig.java | +52è¡Œ | æ–°å¢å­—æ®µå’ŒparseSize()æ–¹æ³• |
| FileValidationServiceImpl.java | -12è¡Œ | ç§»é™¤å¸¸é‡ï¼Œä½¿ç”¨é…ç½®å€¼ |
| VideoParseServiceImpl.java | Â±0è¡Œ | æ›¿æ¢é­”æ³•å€¼ä¸ºé…ç½®å¼•ç”¨ |
| **æ€»è®¡** | **+40è¡Œ** | **å‡€å¢ä»£ç å…·æœ‰æ›´å¥½çš„å¯ç»´æŠ¤æ€§** |

---

## ğŸ“ ç»éªŒæ€»ç»“

### **è¯†åˆ«é­”æ³•å€¼çš„æ ‡å¿—**
1. âŒ ç¡¬ç¼–ç çš„æ•°å­—ï¼ˆé™¤äº† 0, 1, -1ï¼‰
2. âŒ åŒä¸€æ•°å€¼åœ¨å¤šå¤„é‡å¤
3. âŒ ç¼ºå°‘å‘½åè¯´æ˜å«ä¹‰
4. âŒ ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘

### **é‡æ„æœ€ä½³å®è·µ**
1. âœ… é…ç½®å¤–éƒ¨åŒ–ï¼ˆé…ç½®æ–‡ä»¶ï¼‰
2. âœ… æä¾›é»˜è®¤å€¼ï¼ˆä»£ç ä¸­ï¼‰
3. âœ… å•ä½æ¸…æ™°ï¼ˆ20M vs 20971520ï¼‰
4. âœ… æ–‡æ¡£å®Œæ•´ï¼ˆæ³¨é‡Šè¯´æ˜ï¼‰

---

## ğŸ“Œ ç›¸å…³é“¾æ¥

- [VideoParseConfig.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)
- [FileValidationServiceImpl.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/service/impl/FileValidationServiceImpl.java)
- [VideoParseServiceImpl.java](d:/JavaCodeStudy/wangyiyun-music/src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java)
- [application.yaml](d:/JavaCodeStudy/wangyiyun-music/src/main/resources/application.yaml)

---

**é‡æ„å®Œæˆæ—¶é—´**: 2026-01-31
**é‡æ„äººå‘˜**: AI Assistant + User Code Review
**å½±å“èŒƒå›´**: è§†é¢‘è§£ææ¨¡å—é…ç½®ç®¡ç†
