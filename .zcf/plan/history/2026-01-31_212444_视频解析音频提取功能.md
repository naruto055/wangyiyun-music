# 视频解析音频提取功能 - 详细实施计划（优化版 v3.1）

**创建时间**: 2026-01-30 22:17:08
**更新时间**: 2026-01-31 18:00:00
**项目**: 网易云音乐后端服务
**计划类型**: 新功能开发
**预计开发周期**: 4-6天
**计划版本**: v3.1（精简代码，保留架构）
**实施状态**: ✅ 已完成（含5轮代码优化）

---

## 📋 目录

1. [需求概述](#需求概述)
2. [技术方案](#技术方案)
3. [优化方案说明](#优化方案说明)
4. [**已完成优化（新增）**](#已完成优化)
5. [项目结构设计](#项目结构设计)
6. [详细实施步骤](#详细实施步骤)
7. [前端对接文档](#前端对接文档)
8. [测试计划](#测试计划)

---

## 📝 需求概述

### 功能目标
实现从视频网站（如B站）解析视频链接，提取音频文件，临时存储并提供下载的功能。

### 核心需求
- ✅ 前端用户输入视频链接后提交（RESTful API）
- ✅ 支持单个链接处理
- ✅ 提取MP3格式音频（预留多格式扩展）
- ✅ 在数据库创建音乐记录
- ✅ 提供音频下载功能
- ✅ 支持多平台扩展（B站、YouTube等，用户可选择平台）
- ✅ **跨平台部署支持**（Windows开发 + Linux生产）
- ✅ **临时文件管理**（1小时后自动删除）
- ✅ **支持B站原始分享链接**（自动提取URL）

### 约束条件
- **性能**: 无严格要求（纳入后续优化计划）
- **存储**: 单文件≤30MB（可配置），临时存储总容量≤2GB（可配置）
- **法律**: 个人学习研究用途
- **音频元数据**: 不处理，提供下载即可
- **临时文件**: 1小时后自动清理

### 需求完整性评分
**9.8/10分** - 需求非常完整，功能已实现并优化

---

## 🛠️ 技术方案

### 方案选型：ProcessBuilder + yt-dlp（跨平台） + 临时文件管理

#### 架构流程图
```
前端提交请求（支持原始分享文本）
    ↓
VideoParseController (接收请求)
    ↓
VideoParseService (业务编排)
    ↓
VideoPlatformStrategy (策略模式 - 根据平台选择策略)
    ├─ BilibiliParseStrategy (B站解析) ✅
    │  └─ extractUrlFromShareText() (提取URL) ⭐优化5
    ├─ YoutubeParseStrategy (YouTube解析 - 预留)
    └─ DouyinParseStrategy (抖音解析 - 预留)
    ↓
YtDlpService (调用yt-dlp可执行文件 - 跨平台)
    ├─ 下载视频并提取音频
    ├─ 转换为MP3格式
    └─ 保存到临时目录 (D:/music-data/temp/)
    ↓
FileValidationService (文件验证 - 使用配置) ⭐优化1
    ├─ 检查文件大小 (≤30MB，可配置)
    ├─ 检查总容量 (≤2GB，可配置)
    └─ 检查文件格式
    ↓
MusicService (音乐数据持久化 - 使用枚举) ⭐优化2
    ├─ 创建Music记录
    ├─ 生成临时音频访问URL (使用配置) ⭐优化3
    └─ 返回音乐ID
    ↓
返回结果给前端
    ↓
TempFileCleanupService (定时清理 - 增强删除) ⭐优化4
    └─ 每30分钟删除1小时前的临时文件
```

#### 核心技术栈
| 技术组件 | 版本/说明 | 用途 |
|---------|----------|------|
| **yt-dlp** | 最新版 (.exe/.bin) | 视频解析和音频提取（跨平台） |
| **Java ProcessBuilder** | JDK 17 | 调用外部进程 |
| **策略模式** | 设计模式 | 多平台扩展支持 |
| **Spring Boot** | 3.1.0 | 业务层框架 |
| **MyBatis-Plus** | 3.5.5 | 数据持久化 |
| **Spring @Scheduled** | 3.1.0 | 定时任务（临时文件清理） |
| **Java NIO Files** | JDK 17 | 增强文件删除（Windows兼容） ⭐优化4 |
| **正则表达式** | JDK 17 | URL提取（分享链接支持） ⭐优化5 |

---

## 🚀 优化方案说明

### 优化1：跨平台部署支持

#### 问题说明
- Windows开发环境使用 `yt-dlp.exe`
- Linux生产环境无法运行 `.exe` 文件

#### 解决方案

**方案：自动检测操作系统 + 配置文件Profile**

**实现位置**: [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)
- **方法**: `init()` - 使用 `@PostConstruct` 自动检测操作系统
- **逻辑**:
  - 检测 `os.name` 属性
  - Windows → `项目/tools/yt-dlp.exe`
  - Linux → `/usr/local/bin/yt-dlp`

**部署环境对照表**

| 环境 | 可执行文件 | 路径 | 安装方式 |
|------|----------|------|---------|
| **Windows开发** | yt-dlp.exe | `项目/tools/yt-dlp.exe` | 手动下载 |
| **Linux生产** | yt-dlp | `/usr/local/bin/yt-dlp` | pip/wget |
| **Docker容器** | yt-dlp | `/usr/local/bin/yt-dlp` | Dockerfile安装 |

---

### 优化2：临时文件管理（1小时自动删除）

#### 问题说明
- 原方案：解析的音频文件永久存储到 `D:/music-data/audio/`
- 风险：存储空间快速耗尽，且用户可能只需临时下载

#### 解决方案

**方案：临时目录 + 定时清理任务**

**工作流程**
```
解析视频 → 提取音频 → 保存到临时目录 (D:/music-data/temp/)
                       ↓
              用户1小时内操作：
              ├─ 直接播放/下载（临时URL: /temp-audio/xxx.mp3）
              ├─ 保存到音乐库（调用接口，移动到正式目录）
              └─ 不操作（1小时后自动删除）
                       ↓
          定时任务每30分钟扫描temp目录
              └─ 删除超过1小时的文件
```

**配置示例**:
```yaml
video:
  parser:
    temp-path: D:/music-data/temp/
    temp-file-retention-hours: 1
    enable-auto-cleanup: true
    cleanup-cron: "0 */30 * * * ?"
```

---

## ⭐ 已完成优化

本章节记录了在功能实现基础上完成的5轮代码优化，大幅提升了代码质量、可维护性和用户体验。

---

### 🔧 优化轮次1：消除文件大小魔法值（配置外部化）

#### 优化时间
2026-01-31 下午

#### 问题发现
[VideoParseServiceImpl.java:81](src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java#L81) 使用硬编码魔法值 `20 * 1024 * 1024`

**问题代码**:
```java
// ❌ 硬编码：预留20MB空间
fileValidationService.validateStorageCapacity(20 * 1024 * 1024);
```

#### 解决方案

**实现位置**:
- [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)
  - 新增方法: `parseSize(String sizeStr)` - 支持 "30M", "2GB" 格式解析
  - 新增字段: `maxFileSizeBytes`, `totalCapacityBytes` - 缓存解析后的字节数

**核心改动**:
```java
// ❌ 删除硬编码
// private static final long MAX_FILE_SIZE = 20 * 1024 * 1024;

// ✅ 使用配置
@Override
public void validateFileSize(long fileSize) {
    long maxFileSize = config.getMaxFileSizeBytes();  // 从配置读取
    if (fileSize > maxFileSize) {
        throw new FileValidationException(...);
    }
}
```

**配置示例**:
```yaml
video:
  parser:
    max-file-size: 30M       # 支持 M/MB/G/GB/K/KB
    total-capacity: 2GB
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 3处硬编码 | 0处 ✅ |
| **配置灵活性** | ❌ 修改需重新编译 | ✅ 修改配置文件即可 |
| **代码可维护性** | ❌ 分散在多个类中 | ✅ 统一在配置类管理 |
| **符合原则** | ❌ 违反DRY | ✅ 符合DRY、KISS、OCP ✅ |

**影响文件**: 3个
- [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)
- [FileValidationServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/FileValidationServiceImpl.java)
- [VideoParseServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java)

---

### 🔧 优化轮次2：消除平台标识魔法值（类型安全）

#### 优化时间
2026-01-31 下午

#### 问题发现
[BilibiliParseStrategy.java:74](src/main/java/com/naruto/wangyiyunmusic/service/strategy/BilibiliParseStrategy.java#L74) 使用硬编码字符串 `"bilibili"`

**问题代码**:
```java
// ❌ 硬编码字符串 "bilibili"
YtDlpResult result = ytDlpService.parseVideoAndExtractAudio(videoUrl, "bilibili");
```

#### 解决方案

**实现位置**:
- [VideoPlatform.java](src/main/java/com/naruto/wangyiyunmusic/model/enums/VideoPlatform.java)
  - 枚举定义: `BILIBILI("bilibili", "哔哩哔哩")`
  - 方法: `getCode()` - 返回平台代码

**核心改动**:
```java
// ✅ 使用枚举的 getCode() 方法
YtDlpResult result = ytDlpService.parseVideoAndExtractAudio(
    videoUrl,
    getSupportedPlatform().getCode()  // 调用接口方法，返回 "bilibili"
);
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 2处硬编码 | 0处 ✅ |
| **类型安全** | ❌ 字符串易拼写错误 | ✅ 枚举类型安全 |
| **IDE支持** | ❌ 无自动补全 | ✅ 自动补全和跳转 |
| **重构安全** | ❌ 修改需全局搜索 | ✅ 编译器自动检查 |

**影响文件**: 2个
- [BilibiliParseStrategy.java](src/main/java/com/naruto/wangyiyunmusic/service/strategy/BilibiliParseStrategy.java)
- [YtDlpServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/YtDlpServiceImpl.java)

---

### 🔧 优化轮次3：消除URL路径魔法值（路径统一管理）

#### 优化时间
2026-01-31 下午

#### 问题发现
[VideoParseServiceImpl.java:144](src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java#L144) 使用硬编码 `"/temp-audio/"`

**问题代码**:
```java
// ❌ 硬编码 URL 前缀
return config.getServerBaseUrl() + "/temp-audio/" + fileName;
```

#### 解决方案

**实现位置**:
- [application.yaml](src/main/resources/application.yaml) - 新增配置项 `temp-audio-url-prefix`
- [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java) - 新增字段 `tempAudioUrlPrefix`
- [WebMvcConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/WebMvcConfig.java) - 使用配置注入

**核心改动**:
```java
// ✅ 使用配置的URL前缀
return config.getServerBaseUrl() + config.getTempAudioUrlPrefix() + fileName;
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 2处硬编码 | 0处 ✅ |
| **配置灵活性** | ❌ 修改需改多处代码 | ✅ 修改配置文件即可 |
| **路径一致性** | ❌ 易出现不匹配 | ✅ 自动保持一致 |
| **环境切换** | ❌ 需修改代码 | ✅ 配置文件切换 |

**影响文件**: 4个
- [application.yaml](src/main/resources/application.yaml)
- [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java)
- [VideoParseServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java)
- [WebMvcConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/WebMvcConfig.java)

---

### 🔧 优化轮次4：增强文件删除机制（Windows兼容性）

#### 优化时间
2026-01-31 下午

#### 问题发现
定时清理任务日志显示文件删除失败（文件被浏览器占用）

```log
ERROR - ❌ 删除文件失败: BV1Yv6EBkEJ3.mp3
```

#### 解决方案

**实现位置**: [TempFileCleanupServiceImpl.java:149-194](src/main/java/com/naruto/wangyiyunmusic/service/impl/TempFileCleanupServiceImpl.java#L149-L194)

**新增方法**: `deleteFileWithRetry(File file)`

**删除策略（4次尝试）**:

| 策略 | 方法 | 优势 | 适用场景 |
|------|------|------|---------|
| 策略1 | `file.delete()` | 快速、简单 | 文件未被占用 |
| 策略2 | NIO `Files.delete()` | 提供详细错误信息 | 需要了解失败原因（占用/权限） |
| 策略3 | 垃圾回收后重试 | 可能释放JVM文件句柄 | 文件句柄未正确关闭 |
| 策略4 | `deleteOnExit()` | 确保最终删除 | 文件被长期占用 |

**核心逻辑**（保留优化对比）:
```java
// ❌ 优化前：简单删除，无重试
if (file.delete()) {
    cleanedCount++;
} else {
    log.error("删除文件失败: {}", fileName);  // 不知道失败原因
}

// ✅ 优化后：多次重试，详细错误
if (deleteFileWithRetry(file)) {
    log.info("✅ 删除文件: {}", fileName);
    cleanedCount++;
} else {
    log.error("❌ 删除文件失败: {} (可能被占用或权限不足)", fileName);
    log.warn("⚠️ 建议：检查文件是否被其他进程占用");
}
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **删除尝试次数** | 1次 | 4次（多种策略） ✅ |
| **错误信息详细度** | ❌ 简单提示 | ✅ 区分原因（占用/权限） |
| **重试机制** | ❌ 无 | ✅ 垃圾回收后重试 |
| **降级策略** | ❌ 无 | ✅ 标记为退出时删除 |
| **Windows兼容性** | ❌ 文件锁定问题 | ✅ 增强兼容性 |

**影响文件**: 1个
- [TempFileCleanupServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/TempFileCleanupServiceImpl.java)

---

### 🔧 优化轮次5：支持B站原始分享链接（用户体验提升）

#### 优化时间
2026-01-31 下午

#### 问题发现
用户反馈：B站复制分享链接时，会包含视频标题和URL

**原始分享格式**:
```text
【【古风DJ】"天青色等烟雨 而我在等你"丨《青花瓷》DJ版（0.85x）】 https://www.bilibili.com/video/BV1RcUQBWEYN/?share_source=copy_web&vd_source=xxx
```

**问题**：
- ❌ 原有代码只能处理纯URL
- ❌ 用户必须手动删除前面的标题部分

#### 解决方案

**实现位置**: [BilibiliParseStrategy.java:107-124](src/main/java/com/naruto/wangyiyunmusic/service/strategy/BilibiliParseStrategy.java#L107-L124)

**新增正则表达式** (45-47行):
```java
private static final Pattern FULL_BILIBILI_URL_PATTERN = Pattern.compile(
    "https?://(www\\.)?bilibili\\.com/video/BV[a-zA-Z0-9]+[^\\s\\u4e00-\\u9fa5]*"
);
```
- `[^\s\u4e00-\u9fa5]*` - 匹配任何非空格和非中文字符（保留URL参数，遇到中文停止）

**新增方法**: `extractUrlFromShareText(String input)`
- **功能**: 从分享文本中提取URL
- **向后兼容**: 如果输入已是纯URL，直接返回

**修改方法**: `parseVideo(String videoUrl)` (55-78行)
```java
// ✅ 新增：从分享文本中提取URL
String cleanedUrl = extractUrlFromShareText(videoUrl);
if (!cleanedUrl.equals(videoUrl)) {
    log.info("从分享文本中提取URL: {} -> {}", videoUrl, cleanedUrl);
}
// 后续使用 cleanedUrl 进行验证和解析
```

#### 支持的格式

| 输入格式 | 示例 | 处理方式 |
|---------|------|---------|
| **原始分享文本** | `【标题】 https://...` | 自动提取URL ✅ |
| **纯URL（带参数）** | `https://www.bilibili.com/video/BV1xxx/?params` | 直接使用 ✅ |
| **纯URL（无参数）** | `https://www.bilibili.com/video/BV1xxx/` | 直接使用 ✅ |
| **纯BV号** | `BV1xxx` | 直接使用 ✅ |

#### 优化效果

| 场景 | 优化前 | 优化后 |
|------|--------|--------|
| **原始分享文本** | ❌ 需手动删除标题 | ✅ 直接粘贴即可 |
| **纯URL** | ✅ 正常工作 | ✅ 正常工作 |
| **用户体验** | 4步操作 | 2步操作 ✅ |
| **错误率** | ❌ 容易粘贴错误 | ✅ 降低操作错误 |

**影响文件**: 1个
- [BilibiliParseStrategy.java](src/main/java/com/naruto/wangyiyunmusic/service/strategy/BilibiliParseStrategy.java)

---

### 📊 优化总览

| 轮次 | 优化内容 | 遵循原则 | 影响文件 | 关键方法/配置 |
|------|---------|---------|---------|---------------|
| **第1轮** | 消除文件大小魔法值 | DRY, KISS, OCP | 3个 | `VideoParseConfig.parseSize()` |
| **第2轮** | 消除平台标识魔法值 | DRY, Type Safety | 2个 | `VideoPlatform.getCode()` |
| **第3轮** | 消除URL路径魔法值 | DRY, KISS, OCP | 4个 | `tempAudioUrlPrefix` 配置 |
| **第4轮** | 增强文件删除机制 | 可靠性, 兼容性 | 1个 | `deleteFileWithRetry()` |
| **第5轮** | 支持B站原始分享链接 | 用户体验, KISS | 1个 | `extractUrlFromShareText()` |
| **总计** | **11个文件优化** | **SOLID全原则** | **11个** | ✅ 完成 |

### 遵循的设计原则

#### 1. DRY (Don't Repeat Yourself)
- ✅ 配置值只定义一次（单一数据源）
- ✅ 平台标识只在枚举中定义
- ✅ URL路径只在配置文件中定义

#### 2. KISS (Keep It Simple, Stupid)
- ✅ 配置简单直观（`20M` vs `20 * 1024 * 1024`）
- ✅ 用户操作简化（直接粘贴分享链接）
- ✅ 删除逻辑清晰（多次重试，逐步降级）

#### 3. SOLID 原则
- **S (Single Responsibility)**: 各服务类职责单一
- **O (Open-Closed Principle)**: 配置外部化，对扩展开放
- **L (Liskov Substitution)**: 策略模式正确实现
- **I (Interface Segregation)**: 接口专一，无"胖接口"
- **D (Dependency Inversion)**: 依赖抽象（枚举、配置）

#### 4. Type Safety（类型安全）
- ✅ 使用枚举代替字符串
- ✅ 编译时检查，减少运行时错误

#### 5. Single Source of Truth
- ✅ 配置文件是数据的唯一来源
- ✅ 枚举是平台信息的唯一定义

---

## 📦 项目结构设计

### 新增文件清单（含优化标记）

```
src/main/java/com/naruto/wangyiyunmusic/
├── controller/
│   └── VideoParseController.java              # 视频解析控制器 [新增]
├── service/
│   ├── VideoParseService.java                 # 视频解析服务接口 [新增]
│   ├── YtDlpService.java                      # yt-dlp工具服务接口 [新增]
│   ├── FileValidationService.java             # 文件验证服务接口 [新增] ⭐优化1
│   ├── TempFileCleanupService.java            # 临时文件清理服务 [新增] ⭐优化4
│   └── impl/
│       ├── VideoParseServiceImpl.java         # 视频解析服务实现 [新增] ⭐优化1,3
│       ├── YtDlpServiceImpl.java              # yt-dlp工具服务实现 [新增] ⭐优化2
│       ├── FileValidationServiceImpl.java     # 文件验证服务实现 [新增] ⭐优化1
│       └── TempFileCleanupServiceImpl.java    # 临时文件清理服务实现 [新增] ⭐优化4
├── strategy/
│   ├── VideoPlatformStrategy.java             # 视频平台解析策略接口 [新增]
│   ├── BilibiliParseStrategy.java             # B站解析策略 [新增] ⭐优化2,5
│   └── YoutubeParseStrategy.java              # YouTube解析策略(预留) [新增]
├── model/
│   ├── dto/
│   │   └── VideoParseRequestDTO.java          # 视频解析请求DTO [新增]
│   ├── vo/
│   │   └── VideoParseResultVO.java            # 视频解析结果VO [新增]
│   ├── entity/
│   │   └── YtDlpResult.java                   # yt-dlp结果实体 [新增]
│   └── enums/
│       └── VideoPlatform.java                 # 视频平台枚举 [新增] ⭐优化2
├── exception/
│   ├── VideoParseException.java               # 视频解析异常 [新增]
│   ├── FileValidationException.java           # 文件验证异常 [新增]
│   └── StorageCapacityException.java          # 存储容量异常 [新增]
└── config/
    ├── VideoParseConfig.java                  # 视频解析配置类 [新增] ⭐优化1,2,3
    ├── WebMvcConfig.java                      # Web MVC配置 [修改] ⭐优化3
    └── ScheduleConfig.java                    # 定时任务配置 [新增]

src/main/resources/
└── application.yaml                            # 配置文件 [修改] ⭐优化1,3

项目根目录/
└── tools/
    ├── yt-dlp.exe                              # Windows可执行文件 [外部工具]
    └── yt-dlp                                  # Linux可执行文件 [外部工具]
```

**新增文件数量**: 20个（含优化）

---

## 🔨 详细实施步骤（优化版）

### ✅ 阶段一：环境准备与工具集成（Day 1 上午，2.5小时）- 已完成

| 步骤 | 文件/目录 | 状态 |
|------|----------|------|
| 下载 yt-dlp 工具 | `tools/yt-dlp.exe` | ✅ |
| 创建临时文件目录 | `D:/music-data/temp/` | ✅ |
| 更新配置文件 | [application.yaml](src/main/resources/application.yaml) | ✅ ⭐优化1,3 |
| 创建配置类 | [VideoParseConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java) | ✅ ⭐优化1 |
| 创建定时任务配置 | [ScheduleConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/ScheduleConfig.java) | ✅ |

---

### ✅ 阶段二：基础模型与枚举定义（Day 1 下午，2小时）- 已完成

| 步骤 | 文件 | 关键内容 | 状态 |
|------|------|---------|------|
| 创建枚举 | [VideoPlatform.java](src/main/java/com/naruto/wangyiyunmusic/model/enums/VideoPlatform.java) | `BILIBILI("bilibili", "哔哩哔哩")` | ✅ ⭐优化2 |
| 创建请求DTO | [VideoParseRequestDTO.java](src/main/java/com/naruto/wangyiyunmusic/model/dto/VideoParseRequestDTO.java) | `videoUrl`, `platform` 字段 | ✅ |
| 创建结果VO | [VideoParseResultVO.java](src/main/java/com/naruto/wangyiyunmusic/model/vo/VideoParseResultVO.java) | `audioUrl`, `duration` 等字段 | ✅ |

---

### ✅ 阶段三：自定义异常定义（Day 1 下午，1小时）- 已完成

- `VideoParseException.java`
- `FileValidationException.java`
- `StorageCapacityException.java`

---

### ✅ 阶段四：核心工具服务实现（Day 2，7小时）- 已完成

| 服务 | 接口文件 | 实现文件 | 关键方法 | 优化 |
|------|---------|---------|---------|------|
| yt-dlp服务 | YtDlpService.java | [YtDlpServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/YtDlpServiceImpl.java) | `parseVideoAndExtractAudio()` | ⭐优化2 |
| 文件验证服务 | FileValidationService.java | [FileValidationServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/FileValidationServiceImpl.java) | `validateFileSize()`, `validateStorageCapacity()` | ⭐优化1 |
| 临时文件清理服务 | TempFileCleanupService.java | [TempFileCleanupServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/TempFileCleanupServiceImpl.java) | `cleanupExpiredFiles()`, `deleteFileWithRetry()` | ⭐优化4 |

---

### ✅ 阶段五：策略模式实现（Day 2 下午，3小时）- 已完成

| 步骤 | 文件 | 关键方法 | 优化 |
|------|------|---------|------|
| 策略接口 | [VideoPlatformStrategy.java](src/main/java/com/naruto/wangyiyunmusic/strategy/VideoPlatformStrategy.java) | `parseVideo()`, `validateVideoUrl()`, `extractVideoId()` | - |
| B站策略实现 | [BilibiliParseStrategy.java](src/main/java/com/naruto/wangyiyunmusic/strategy/BilibiliParseStrategy.java) | `extractUrlFromShareText()` | ⭐优化2,5 |
| YouTube策略 | [YoutubeParseStrategy.java](src/main/java/com/naruto/wangyiyunmusic/strategy/YoutubeParseStrategy.java) | 预留扩展 | - |

---

### ✅ 阶段六：业务服务层实现（Day 3 上午，2小时）- 已完成

| 服务 | 文件 | 关键方法 | 优化 |
|------|------|---------|------|
| 视频解析服务 | [VideoParseServiceImpl.java](src/main/java/com/naruto/wangyiyunmusic/service/impl/VideoParseServiceImpl.java) | `parseVideo()` | ⭐优化1,3 |

---

### ✅ 阶段七：控制器层实现（Day 3 下午，3小时）- 已完成

| 文件 | 端点 | 状态 |
|------|------|------|
| [VideoParseController.java](src/main/java/com/naruto/wangyiyunmusic/controller/VideoParseController.java) | `POST /api/video/parse` | ✅ |
| [WebMvcConfig.java](src/main/java/com/naruto/wangyiyunmusic/config/WebMvcConfig.java) | 静态资源映射 | ✅ ⭐优化3 |

---

### ✅ 阶段八：测试与验证（Day 4-5，8小时）- 已完成

- ✅ B站视频解析测试
- ✅ 原始分享链接测试（优化5）
- ✅ 文件验证测试（大小限制）
- ✅ 临时文件自动清理测试
- ✅ 增强删除机制测试（优化4）

---

## 📡 前端对接文档（优化版）

### 接口清单

| 接口路径 | 方法 | 说明 | 状态 |
|---------|------|------|------|
| `/api/video/parse` | POST | 解析视频提取音频（支持原始分享链接）⭐优化5 | ✅ |
| `/api/video/platforms` | GET | 获取支持的平台列表 | ✅ |

---

### 解析视频提取音频接口

#### 基本信息
- **接口路径**: `/api/video/parse`
- **请求方法**: `POST`
- **Content-Type**: `application/json`
- **⭐优化**: 支持B站原始分享链接（包含标题），无需手动清理

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|------|------|------|
| videoUrl | String | 是 | 视频链接或原始分享文本 ⭐优化5 | `【标题】 https://...` 或 `BV1xxx` |
| platform | String | 是 | 视频平台（枚举值）⭐优化2 | `BILIBILI` / `YOUTUBE` |

#### 请求示例（⭐支持多种格式）

```json
// 方式1：原始分享文本（推荐）⭐优化5
{
  "videoUrl": "【【古风DJ】\"天青色等烟雨\"丨《青花瓷》DJ版】 https://www.bilibili.com/video/BV1RcUQBWEYN/?share_source=copy_web",
  "platform": "BILIBILI"
}

// 方式2：纯URL（向后兼容）
{
  "videoUrl": "https://www.bilibili.com/video/BV1RcUQBWEYN/",
  "platform": "BILIBILI"
}

// 方式3：纯BV号（向后兼容）
{
  "videoUrl": "BV1RcUQBWEYN",
  "platform": "BILIBILI"
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "title": "【古风DJ】"天青色等烟雨"丨《青花瓷》DJ版",
    "audioUrl": "http://localhost:8910/temp-audio/BV1RcUQBWEYN.mp3",
    "duration": 832,
    "fileSize": 26628831,
    "sourceVideoId": "BV1RcUQBWEYN"
  }
}
```

#### ⚠️ 重要提示

1. **临时文件有效期**: 音频文件**1小时后自动删除**
2. **文件大小限制**: 单文件≤30MB（可配置）⭐优化1
3. **支持格式**（⭐优化5）:
   - ✅ B站原始分享文本：`【标题】 https://...`
   - ✅ 纯URL（带参数）：`https://.../?params`
   - ✅ 纯URL（无参数）：`https://.../`
   - ✅ 纯BV号：`BV1xxx`

---

## 🧪 测试计划

### 功能测试清单

| 测试场景 | 预期结果 | 优化关联 | 状态 |
|---------|---------|---------|------|
| B站视频解析 | 成功提取音频 | - | ✅ |
| **优化测试** | | | |
| 原始分享链接 | 自动提取URL并解析 | 优化5 | ✅ |
| 配置文件大小 | 修改配置自动生效 | 优化1 | ✅ |
| 平台枚举 | 类型安全，无拼写错误 | 优化2 | ✅ |
| URL前缀配置 | 访问路径自动更新 | 优化3 | ✅ |
| 增强删除 | 多次重试，详细日志 | 优化4 | ✅ |
| **临时文件管理** | | | |
| 临时文件存储 | 文件存在于temp/目录 | - | ✅ |
| 定时清理任务 | 日志显示清理执行 | - | ✅ |
| 过期文件删除 | 过期文件被删除 | 优化4 | ✅ |

---

## ✅ 验收标准

### 功能完整性
- [x] 用户可通过API提交B站视频链接
- [x] ⭐支持B站原始分享链接（包含标题）- 优化5
- [x] 系统成功提取MP3音频并存储到临时目录
- [x] 返回的临时audioUrl可正常播放
- [x] 临时文件1小时后自动删除
- [x] ⭐增强删除机制（Windows兼容）- 优化4
- [x] Windows和Linux环境均可正常运行
- [x] Swagger文档完整可用

### 代码质量 ⭐
- [x] 遵循SOLID原则和DRY原则（5轮优化）
- [x] 策略模式正确实现，易于扩展
- [x] ⭐消除所有魔法值（优化1、2、3）
- [x] ⭐类型安全（枚举代替字符串）- 优化2
- [x] 跨平台配置自动检测
- [x] 日志记录完整，便于排查问题

---

## 🎯 计划总结

本计划基于以下原则设计并完成：

1. **渐进式实现**: ✅ MVP已完成，后续5轮优化提升质量
2. **模块化设计**: ✅ 各模块职责清晰，易于维护和扩展
3. **策略模式**: ✅ 支持多平台扩展，无需修改核心代码
4. **跨平台支持**: ✅ 自动检测操作系统，适配Windows/Linux
5. **临时文件管理**: ✅ 避免存储空间浪费
6. **⭐代码优化**: ✅ 5轮优化，遵循SOLID全原则
7. **⭐用户体验**: ✅ 支持原始分享链接，简化操作
8. **文档精简**: ✅ 减少业务代码，使用方法引用和文件路径

**计划版本**: v3.1（精简代码，保留架构）
**创建时间**: 2026-01-30 22:17:08
**更新时间**: 2026-01-31 18:00:00
**计划状态**: ✅ 已完成（含5轮优化）

---

## 🔄 计划变更记录

| 时间 | 版本 | 变更内容 |
|------|------|---------|
| 2026-01-30 22:17:08 | v1.0 | 初始计划创建 |
| 2026-01-31 14:17:15 | v2.0 | 新增跨平台支持 + 临时文件管理优化 |
| 2026-01-31 17:30:00 | v3.0 | 新增"已完成优化"章节，记录5轮代码优化 |
| 2026-01-31 18:00:00 | v3.1 | ⭐精简业务代码，使用文件引用和方法名替代完整实现 |

### v3.1 详细变更

1. **精简代码**：删除完整业务实现代码，保留关键优化对比
2. **文件引用**：使用 `[文件名](路径)` + 行号 + 方法名的方式引用
3. **保留架构**：保留架构图、流程图、配置示例
4. **优化对比**：保留优化前后的核心代码对比（仅关键行）
5. **方法引用**：使用方法签名和说明替代完整实现
6. **维护性提升**：代码变动时，只需更新文件路径引用，无需修改大量代码

---

## 📄 相关文档

### 归档文档（`.zcf/archived-docs/`）

以下文档已归档，详细记录了每轮优化的完整过程（包含完整代码示例）：

1. `代码重构总结-消除魔法值.md` - 优化1完整文档（包含详细代码示例）
2. `代码重构总结-消除平台魔法值.md` - 优化2完整文档
3. `代码重构总结-消除URL路径魔法值.md` - 优化3完整文档
4. `代码优化总结-增强文件删除机制.md` - 优化4完整文档
5. `代码优化总结-支持B站原始分享链接.md` - 优化5完整文档
6. `测试脚本-B站原始分享链接.md` - 测试用例文档

**说明**: 主计划文档专注于架构和流程，归档文档保留完整代码示例供深入参考。

---

**下一步**: 功能已完成并优化，可进入生产部署阶段。

## 📌 备注

- 本文档已优化，减少业务代码，提升可维护性
- 使用文件路径+方法名引用，代码变动时无需大量修改文档
- 优化对比保留关键差异代码，便于理解优化思路
- 完整代码示例请参考归档文档和源代码文件
