# 音频资源限流防盗链功能实施规划

## 项目任务分解规划

**文档生成时间**: 2026-01-31
**功能模块**: 音频资源安全防护
**实施负责人**: AI Agent + 开发团队
**预估总工时**: 2-3天

---

## 已明确的决策

### 技术选型（已确定）

- **限流技术**: Guava RateLimiter + ConcurrentHashMap（内存实现）
- **防盗链**: 自定义 Servlet Filter
- **存储方案**: 内存存储 + 定期清理（预留 Redis 升级接口）
- **工具库**: Hutool 5.8.32（支持 Jakarta Servlet API）
- **带宽控制**: 可选实现（后续优化）
- **认证授权**: 暂不实施（开放访问）

### 核心设计原则

1. **轻量级优先**: 基于内存的实现，无需引入 Redis 等外部依赖
2. **性能优先**: Filter 处理时间 < 10ms，不影响正常播放体验
3. **可配置化**: 所有阈值可在 `application.yaml` 中配置
4. **可扩展性**: 预留升级到 Redis 分布式限流的接口
5. **兼容性保障**: 不影响现有的 HTTP Range 请求支持

---

## 整体规划概述

### 项目目标

**核心目标**: 防止恶意批量下载和流量滥用，保护音频资源服务器带宽和存储安全

**具体目标**:
1. ✅ **智能限流**: 基于IP的多维度限流（请求频率、并发连接、文件数量）
2. ✅ **防盗链**: 基于 Referer、User-Agent、IP 的多重检查
3. ✅ **动态黑名单**: 自动识别恶意IP并临时封禁
4. ⚡ **性能优化**: Filter 处理延迟 < 10ms
5. 📊 **可监控性**: 完整的日志记录和统计信息

### 技术栈

| 层级 | 技术组件 | 版本 | 用途 |
|------|---------|------|------|
| **限流核心** | Guava RateLimiter | 32.1.3-jre | 令牌桶算法实现 |
| **并发控制** | ConcurrentHashMap | JDK 17 | 线程安全的内存存储 |
| **工具库** | Hutool | 5.8.32 | Java工具库（支持Jakarta Servlet） |
| **过滤器** | Servlet Filter | Spring Boot 3.1.0 | 请求拦截 |
| **定时任务** | @Scheduled | Spring Boot 3.1.0 | 定期清理过期数据 |
| **日志** | SLF4J + Logback | Spring Boot 3.1.0 | 日志记录 |
| **配置** | @ConfigurationProperties | Spring Boot 3.1.0 | 配置绑定 |

### 主要阶段

1. **阶段1：依赖配置与基础架构**（0.5天）
   - 添加 Guava 和 Hutool 依赖
   - 创建配置类和属性绑定
   - 创建自定义异常类

2. **阶段2：智能限流功能实现**（1天）
   - IP 限流管理器
   - 多维度限流策略
   - 动态黑名单机制
   - 定时清理任务

3. **阶段3：防盗链功能实现**（0.5天）
   - Referer 白名单检查
   - User-Agent 黑名单检查
   - IP 黑名单检查
   - 防盗链 Filter

4. **阶段4：集成与测试**（1天）
   - Filter 注册与优先级配置
   - 单元测试编写
   - 集成测试
   - 性能测试

---

## 详细任务分解

### 阶段1：依赖配置与基础架构

#### 任务1.1：添加 Guava 和 Hutool 依赖

**目标**: 在 pom.xml 中添加必要依赖

**输入**:
- 现有 `pom.xml` 文件

**输出**:
- 更新后的 `pom.xml`

**涉及文件**:
- `pom.xml`

**实施步骤**:
1. 添加 Guava 依赖（版本: 32.1.3-jre）
2. 添加 Hutool 依赖（版本: 5.8.32，支持 Jakarta Servlet）
3. 执行 Maven 依赖刷新：`mvn clean install`

**验收标准**:
- ✅ Maven 成功下载 Guava 和 Hutool 依赖
- ✅ 项目编译无错误
- ✅ IDE 能识别相关类

**预估工作量**: 0.5小时

---

#### 任务1.2：创建音频安全配置类

**目标**: 创建配置类，绑定 `application.yaml` 中的音频安全配置属性

**输入**:
- 配置需求文档

**输出**:
- `AudioSecurityProperties.java` 配置类
- 更新 `application.yaml` 配置文件

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/config/properties/AudioSecurityProperties.java`
- **修改**: `src/main/resources/application.yaml`

**配置类结构**:

包含三个内部配置类：
- **RateLimitConfig**: 限流配置（Range请求限流、完整下载限流、并发连接数等）
- **AntiLeechConfig**: 防盗链配置（Referer白名单、User-Agent黑名单等）
- **BlacklistConfig**: 黑名单配置（固定黑名单、封禁时长、清理间隔等）

**application.yaml 配置示例**:
```yaml
# 音频安全配置
audio:
  security:
    # 限流配置
    rate-limit:
      enabled: true
      range-requests-per-minute: 100      # Range请求限流
      full-downloads-per-minute: 5        # 完整下载限流
      unique-files-per-minute: 10         # 不同文件数限流
      max-concurrent-connections: 3       # 并发连接数限制
      blacklist-threshold: 20             # 触发黑名单阈值
      window-minutes: 5                   # 统计窗口（分钟）

    # 防盗链配置
    anti-leech:
      enabled: true
      allowed-referers:                   # Referer白名单
        - localhost:8910                  # 后端服务
        - localhost:5174                  # 前端开发服务器（Vite）
        - music.example.com              # 生产环境域名
      allow-empty-referer: true           # 允许空Referer
      blocked-user-agents:                # User-Agent黑名单（正则）
        - ".*[Pp]ython.*"
        - ".*wget.*"
        - ".*curl.*"
        - ".*[Ss]crapy.*"
        - ".*[Bb]ot.*"
        - ".*[Ss]pider.*"

    # 黑名单配置
    blacklist:
      ips: []                             # 固定黑名单IP（可选）
      ban-duration-minutes: 30            # 动态黑名单封禁时长
      cleanup-interval-minutes: 10        # 清理间隔
```

**验收标准**:
- ✅ 配置类能成功绑定 `application.yaml` 配置
- ✅ 所有配置项都有默认值
- ✅ Spring Boot 启动时能正确加载配置
- ✅ 使用 Lombok `@Data` 注解简化代码

**预估工作量**: 1小时

---

#### 任务1.3：创建自定义异常类

**目标**: 创建音频安全相关的自定义异常类

**输入**:

- 异常场景分析

**输出**:
- 2个新的异常类
- 更新全局异常处理器

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/exception/RateLimitException.java`
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/exception/AntiLeechException.java`
- **修改**: `src/main/java/com/naruto/wangyiyunmusic/exception/GlobalExceptionHandler.java`

**异常类设计**:

1. **RateLimitException** - 限流异常
   - 属性：`ip`（IP地址）、`limitType`（限流类型）
   - 触发场景：IP触发限流策略时抛出

2. **AntiLeechException** - 防盗链异常
   - 属性：`ip`（IP地址）、`reason`（拦截原因）
   - 触发场景：请求被防盗链策略拦截时抛出

3. **GlobalExceptionHandler 更新**:
   - 新增 `handleRateLimitException` 方法，返回 HTTP 429 状态码
   - 新增 `handleAntiLeechException` 方法，返回 HTTP 403 状态码

**验收标准**:
- ✅ 异常类继承自 `RuntimeException`
- ✅ 包含必要的属性（IP、类型/原因）
- ✅ GlobalExceptionHandler 能捕获并处理异常
- ✅ 返回正确的 HTTP 状态码（429 限流、403 防盗链）

**预估工作量**: 0.5小时

---

### 阶段2：智能限流功能实现

#### 任务2.1：创建 IP 限流管理器

**目标**: 实现基于 IP 的多维度限流管理器，使用 Guava RateLimiter 和 ConcurrentHashMap

**输入**:
- AudioSecurityProperties 配置
- IP 地址

**输出**:
- IP 限流管理器类

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/service/impl/AudioRateLimitService.java`

**核心功能**:
1. 基于IP的请求频率限流（Range请求 vs 完整下载）
2. 基于IP的并发连接数控制
3. 基于IP的不同文件数限流
4. 动态黑名单机制
5. 定期清理过期数据

**主要方法说明**:

- `allowAccess(ip, isRangeRequest, fileName)`: 核心限流检查方法
  - 检查黑名单
  - 检查并发连接数
  - 检查不同文件数限流
  - 检查请求频率限流（使用 Guava RateLimiter）

- `incrementConnection(ip)`: 增加并发连接数
- `decrementConnection(ip)`: 减少并发连接数（请求完成后调用）
- `cleanupExpiredData()`: 定时清理过期数据（使用 @Scheduled）

**数据结构**:
- `rangeRequestLimiters`: IP -> Range请求限流器（ConcurrentHashMap）
- `fullDownloadLimiters`: IP -> 完整下载限流器（ConcurrentHashMap）
- `ipAccessedFiles`: IP -> 访问的文件名集合（ConcurrentHashMap）
- `ipConcurrentConnections`: IP -> 当前并发连接数（AtomicInteger）
- `ipViolationCounts`: IP -> 限流触发次数（AtomicInteger）
- `dynamicBlacklist`: 动态黑名单（IP -> 封禁到期时间）
- `ipLastAccessTime`: IP -> 最后访问时间（用于清理）

**验收标准**:
- ✅ 能正确限流 Range 请求和完整下载
- ✅ 能正确控制并发连接数
- ✅ 能正确限制不同文件数
- ✅ 能自动将恶意IP加入黑名单
- ✅ 定时清理任务能正常执行
- ✅ 线程安全（使用 ConcurrentHashMap）

**预估工作量**: 3小时

---

### 阶段3：防盗链功能实现

#### 任务3.1：创建防盗链检查服务

**目标**: 实现 Referer、User-Agent、IP 的多重检查逻辑

**输入**:
- HttpServletRequest 对象
- AudioSecurityProperties 配置

**输出**:
- 防盗链检查服务类

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/service/impl/AntiLeechService.java`

**核心功能**:

`checkAntiLeech(request, ip)` 方法执行以下检查：
1. **IP黑名单检查**: 检查固定黑名单配置
2. **User-Agent黑名单检查**: 使用正则表达式匹配，拒绝爬虫和下载工具
3. **Referer白名单检查**: 检查Referer是否包含白名单域名

**工具方法使用**:
- 使用 `StrUtil.nullToDefault()` 获取请求头（Hutool工具类）
- 使用正则表达式匹配 User-Agent 黑名单
- 使用字符串包含检查 Referer 白名单

**验收标准**:
- ✅ 能正确识别IP黑名单
- ✅ 能正确识别恶意 User-Agent（爬虫）
- ✅ 能正确识别非白名单 Referer
- ✅ 支持空 Referer 的可配置开关
- ✅ 正则表达式匹配正常工作

**预估工作量**: 1.5小时

---

### 阶段4：Filter 集成与测试

#### 任务4.1：创建音频限流 Filter

**目标**: 创建 Servlet Filter，集成限流逻辑

**输入**:
- HttpServletRequest/Response
- AudioRateLimitService

**输出**:
- 限流 Filter 类

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/filter/AudioRateLimitFilter.java`

**核心逻辑**:

1. 只拦截 `/audio/**` 路径的请求
2. 检查限流是否启用（可通过配置关闭）
3. 使用 `JakartaServletUtil.getClientIP()` 获取客户端IP（Hutool工具类）
4. 使用 `StrUtil` 分析请求（判断Range请求、提取文件名）
5. 执行限流检查
6. 管理并发连接数（增加/释放）
7. 异常时返回 JSON 响应

**Filter优先级**: @Order(2)（防盗链Filter为1，先执行防盗链检查）

**验收标准**:
- ✅ Filter 能正确拦截 `/audio/**` 请求
- ✅ 限流检查逻辑正常执行
- ✅ 并发连接数正确计数和释放
- ✅ 异常时返回正确的 JSON 响应
- ✅ Filter 执行时间 < 10ms

**预估工作量**: 1小时

---

#### 任务4.2：创建防盗链 Filter

**目标**: 创建 Servlet Filter，集成防盗链逻辑

**输入**:
- HttpServletRequest/Response
- AntiLeechService

**输出**:
- 防盗链 Filter 类

**涉及文件**:
- **新建**: `src/main/java/com/naruto/wangyiyunmusic/filter/AntiLeechFilter.java`

**核心逻辑**:

1. 只拦截 `/audio/**` 路径的请求
2. 检查防盗链是否启用（可通过配置关闭）
3. 使用 `JakartaServletUtil.getClientIP()` 获取客户端IP（Hutool工具类）
4. 执行防盗链检查
5. 异常时返回 JSON 响应

**Filter优先级**: @Order(1)（最先执行，先于限流Filter）

**验收标准**:
- ✅ Filter 能正确拦截 `/audio/**` 请求
- ✅ 防盗链检查逻辑正常执行
- ✅ 异常时返回正确的 JSON 响应
- ✅ Filter 优先级高于限流 Filter（@Order(1)）

**预估工作量**: 0.5小时

---

#### 任务4.3：启用定时任务支持

**目标**: 在主应用类添加 @EnableScheduling 注解

**涉及文件**:
- **修改**: `src/main/java/com/naruto/wangyiyunmusic/WangyiyunMusicApplication.java`

**实施步骤**:

- 使 `AudioRateLimitService` 中的 `@Scheduled` 清理任务生效

**验收标准**:
- ✅ 定时清理任务能正常执行
- ✅ 每10分钟自动清理过期数据

**预估工作量**: 0.1小时

---

## 测试方案

### 测试环境准备

1. **配置文件**：
   - 使用测试配置（较低的限流阈值，便于测试）
   - 配置测试用的白名单和黑名单

2. **测试数据**：
   - 准备至少 10 个测试音频文件（test1.mp3 ~ test10.mp3）
   - 文件大小：500KB ~ 5MB

3. **测试工具**：
   - Postman / cURL（手动测试）
   - JMeter / Apache Bench（性能测试）
   - JUnit 5 + MockMvc（单元测试）

---

### 测试用例设计

#### 1. 限流功能测试

**测试用例 1.1：Range 请求限流**
- **测试步骤**：
  1. 配置 `range-requests-per-minute: 10`
  2. 发送 15 次 Range 请求（`Range: bytes=0-1023`）
  3. 观察第 11-15 次请求的响应

- **预期结果**：
  - 前 10 次请求返回 `200 OK`
  - 第 11-15 次请求返回 `429 Too Many Requests`
  - 响应 JSON：`{"code": 429, "message": "Range请求频率超限"}`

- **测试命令**：
```bash
# 循环发送15次Range请求
for i in {1..15}; do
  curl -H "Range: bytes=0-1023" http://localhost:8910/audio/test1.mp3
  echo "Request $i"
done
```

---

**测试用例 1.2：完整下载限流**
- **测试步骤**：
  1. 配置 `full-downloads-per-minute: 3`
  2. 发送 5 次完整下载请求（无 Range 头）
  3. 观察第 4-5 次请求的响应

- **预期结果**：
  - 前 3 次请求返回 `200 OK`
  - 第 4-5 次请求返回 `429 Too Many Requests`

---

**测试用例 1.3：不同文件数限流**
- **测试步骤**：
  1. 配置 `unique-files-per-minute: 5`
  2. 依次访问 7 个不同的音频文件
  3. 观察第 6-7 次请求的响应

- **预期结果**：
  - 前 5 个不同文件访问成功
  - 第 6-7 个文件访问返回 `429 Too Many Requests`

---

**测试用例 1.4：并发连接数限制**
- **测试步骤**：
  1. 配置 `max-concurrent-connections: 2`
  2. 使用 JMeter 启动 4 个并发线程，每个线程请求同一音频文件
  3. 观察并发连接数

- **预期结果**：
  - 同时最多 2 个请求成功
  - 第 3-4 个请求返回 `429 Too Many Requests`

---

**测试用例 1.5：动态黑名单触发**
- **测试步骤**：
  1. 配置 `blacklist-threshold: 5`
  2. 连续触发 6 次限流（例如超速发送 Range 请求）
  3. 观察日志和后续请求

- **预期结果**：
  - 第 5 次违规后，日志显示 "IP已加入动态黑名单"
  - 后续所有请求返回 `429 Too Many Requests`，消息为 "IP已被封禁"

---

#### 2. 防盗链功能测试

**测试用例 2.1：Referer 白名单检查**
- **测试步骤**：
  1. 配置白名单：`allowed-referers: [localhost:8910, localhost:5174]`
  2. 发送请求，Referer 为 `http://localhost:5174/`
  3. 发送请求，Referer 为 `http://evil.com/`

- **预期结果**：
  - 白名单 Referer 请求成功（200）
  - 非白名单 Referer 请求被拦截（403）

- **测试命令**：
```bash
# 白名单Referer（应成功）
curl -H "Referer: http://localhost:5174/" http://localhost:8910/audio/test1.mp3

# 非白名单Referer（应失败）
curl -H "Referer: http://evil.com/" http://localhost:8910/audio/test1.mp3
```

---

**测试用例 2.2：User-Agent 黑名单检查**
- **测试步骤**：
  1. 配置黑名单：`blocked-user-agents: [".*[Pp]ython.*", ".*wget.*"]`
  2. 发送请求，User-Agent 为 `Python-urllib/3.8`
  3. 发送请求，User-Agent 为 `Mozilla/5.0 (Chrome)`

- **预期结果**：
  - Python UA 请求被拦截（403）
  - Chrome UA 请求成功（200）

- **测试命令**：
```bash
# 黑名单UA（应失败）
curl -A "Python-urllib/3.8" http://localhost:8910/audio/test1.mp3

# 正常UA（应成功）
curl -A "Mozilla/5.0 (Chrome)" -H "Referer: http://localhost:5174/" http://localhost:8910/audio/test1.mp3
```

---

**测试用例 2.3：IP 黑名单检查**
- **测试步骤**：
  1. 配置黑名单：`ips: ["192.168.1.100"]`
  2. 从黑名单 IP 发送请求
  3. 从其他 IP 发送请求

- **预期结果**：
  - 黑名单 IP 请求被拦截（403）
  - 其他 IP 请求成功（200）

---

#### 3. 性能测试

**测试用例 3.1：Filter 处理延迟**
- **测试工具**：JMeter
- **测试场景**：
  - 单线程，连续 1000 次请求
  - 测量 Filter 处理时间（通过日志或 AOP）

- **预期结果**：
  - 平均处理时间 < 5ms
  - P95 < 10ms
  - P99 < 20ms

---

**测试用例 3.2：并发压力测试**
- **测试工具**：JMeter
- **测试场景**：
  - 50 个并发线程
  - 每线程 100 次请求
  - 持续 1 分钟

- **预期结果**：
  - 系统稳定无崩溃
  - 内存占用稳定（无内存泄漏）
  - CPU 占用合理（< 80%）

---

**测试用例 3.3：内存泄漏测试**
- **测试工具**：JProfiler / VisualVM
- **测试场景**：
  - 持续运行 30 分钟
  - 模拟 1000 个不同 IP 的请求
  - 观察内存使用情况

- **预期结果**：
  - 内存使用稳定（无持续增长）
  - 定期清理任务正常执行
  - ConcurrentHashMap 大小合理

---

#### 4. 集成测试

**测试用例 4.1：Filter 执行顺序**
- **测试步骤**：
  1. 同时启用防盗链和限流
  2. 发送一个违反防盗链的请求
  3. 观察响应

- **预期结果**：
  - 防盗链 Filter 先执行（@Order(1)）
  - 返回 403 Forbidden（不会执行到限流 Filter）

---

**测试用例 4.2：配置开关测试**
- **测试步骤**：
  1. 设置 `anti-leech.enabled: false`
  2. 发送违反防盗链的请求
  3. 观察响应

- **预期结果**：
  - 防盗链检查被跳过
  - 请求成功（200）

---

**测试用例 4.3：正常播放体验测试**
- **测试步骤**：
  1. 启用所有防护功能
  2. 使用浏览器播放音频文件
  3. 测试拖拽、暂停、继续播放

- **预期结果**：
  - 播放流畅无卡顿
  - 拖拽正常（Range 请求）
  - 限流不影响正常用户

---

## 验收标准

### 功能验收

1. **限流功能**：
   - ✅ Range 请求限流正常工作（100次/分钟）
   - ✅ 完整下载限流正常工作（5次/分钟）
   - ✅ 不同文件数限流正常工作（10个/分钟）
   - ✅ 并发连接数限制正常工作（3个/IP）
   - ✅ 动态黑名单自动触发（20次违规 -> 封禁30分钟）

2. **防盗链功能**：
   - ✅ Referer 白名单检查正常工作
   - ✅ User-Agent 黑名单检查正常工作
   - ✅ IP 黑名单检查正常工作
   - ✅ 空 Referer 可配置开关

3. **性能指标**：
   - ✅ Filter 平均处理时间 < 5ms
   - ✅ P95 处理时间 < 10ms
   - ✅ 无内存泄漏
   - ✅ 并发1000请求/秒时系统稳定

4. **可配置性**：
   - ✅ 所有阈值可在 `application.yaml` 配置
   - ✅ 支持动态开关（enabled: true/false）
   - ✅ 白名单/黑名单外部化配置

5. **日志与监控**：
   - ✅ 限流触发日志完整
   - ✅ 防盗链拦截日志完整
   - ✅ 黑名单添加日志完整
   - ✅ 定期清理统计日志

### 代码质量验收

1. **代码规范**：
   - ✅ 遵循阿里巴巴 Java 开发手册
   - ✅ 所有类有完整的注释（中文）
   - ✅ 方法有参数和返回值说明
   - ✅ 使用 Lombok 简化代码

2. **测试覆盖**：
   - ✅ 单元测试覆盖率 > 80%
   - ✅ 所有核心方法有测试用例
   - ✅ 集成测试通过

3. **兼容性**：
   - ✅ 不影响现有功能（HTTP Range 请求）
   - ✅ Filter 不与其他 Filter 冲突
   - ✅ 正常用户播放体验不受影响

---

## 风险评估与应对策略

### 风险1：限流策略过于严格，影响正常用户

**风险等级**：中

**风险描述**：
- 如果 `range-requests-per-minute` 设置过低（例如 10），用户频繁拖拽播放可能触发限流

**应对策略**：
1. **合理配置阈值**：
   - Range 请求：100次/分钟（支持频繁拖拽）
   - 完整下载：5次/分钟（防止批量下载）

2. **监控和调整**：
   - 上线后观察日志，统计正常用户的请求频率
   - 根据实际情况调整阈值

3. **IP 白名单**：
   - 预留白名单功能，允许信任 IP 跳过限流

---

### 风险2：内存占用过高（大量 IP 访问）

**风险等级**：中

**风险描述**：
- ConcurrentHashMap 存储每个 IP 的限流数据
- 如果短时间内有大量不同 IP 访问，内存占用可能较高

**应对策略**：
1. **定期清理**：
   - 定时任务每 10 分钟清理过期数据
   - 清理超过 5 分钟未访问的 IP 数据

2. **限制缓存大小**：
   - 如果 IP 数量超过阈值（例如 10000），清理最老的数据

3. **升级到 Redis**：
   - 如果单机内存不足，升级到 Redis 分布式存储

---

### 风险3：Referer 白名单配置错误，导致正常请求被拦截

**风险等级**：高

**风险描述**：
- 如果白名单配置不完整（例如遗漏域名），用户请求可能被误拦截

**应对策略**：
1. **详细配置文档**：
   - 提供清晰的配置示例
   - 说明如何配置多个域名

2. **允许空 Referer**：
   - 默认 `allow-empty-referer: true`，支持直接访问

3. **日志监控**：
   - 记录所有被拦截的 Referer
   - 定期审查是否有误拦截

---

### 风险4：动态黑名单误封正常用户

**风险等级**：中

**风险描述**：
- 如果正常用户触发限流（例如网络波动导致重试），可能被误加入黑名单

**应对策略**：
1. **合理设置阈值**：
   - `blacklist-threshold: 20`（较高阈值，降低误封概率）
   - `window-minutes: 5`（5 分钟窗口）

2. **自动解封**：
   - 动态黑名单有过期时间（30 分钟）
   - 过期后自动解封

3. **手动解封接口**：
   - 如果需要，提供管理 API 手动移除黑名单

---

### 风险5：Filter 性能问题

**风险等级**：低

**风险描述**：
- Filter 处理时间过长，影响响应速度

**应对策略**：
1. **性能优化**：
   - 使用 ConcurrentHashMap（高效并发）
   - 避免在 Filter 中执行复杂计算

2. **性能测试**：
   - 上线前进行压力测试
   - 确保 Filter 处理时间 < 10ms

3. **异步处理**：
   - 如果需要，将日志记录改为异步（使用 AsyncAppender）

---

## 后续优化建议

### 优化方向1：实时监控仪表盘

**建议**：
- 集成 Spring Boot Actuator + Prometheus + Grafana
- 监控指标：
  - 限流触发次数（按类型统计）
  - 防盗链拦截次数（按原因统计）
  - 当前黑名单 IP 数量
  - 当前跟踪 IP 数量
  - Filter 平均处理时间

**优先级**：中

---

### 优化方向2：升级到 Redis 分布式限流

**建议**：
- 基于 Redis + Lua 脚本实现分布式限流
- 支持多实例部署（负载均衡）
- 使用 Redisson 库简化开发

**优先级**：低（仅在多实例部署时需要）

---

### 优化方向3：机器学习异常检测

**建议**：
- 基于历史访问数据，训练异常检测模型
- 自动识别异常访问模式（例如爬虫）
- 动态调整限流策略

**优先级**：低（长期优化）

---

## 附录

### 附录A：配置文件完整示例

```yaml
# 音频安全配置
audio:
  security:
    # 限流配置
    rate-limit:
      enabled: true                           # 是否启用限流
      range-requests-per-minute: 100          # Range请求限流（次/分钟/IP）
      full-downloads-per-minute: 5            # 完整下载限流（次/分钟/IP）
      unique-files-per-minute: 10             # 不同文件数限流（个/分钟/IP）
      max-concurrent-connections: 3           # 并发连接数限制（个/IP）
      blacklist-threshold: 20                 # 触发黑名单的违规次数阈值
      window-minutes: 5                       # 统计窗口时长（分钟）

    # 防盗链配置
    anti-leech:
      enabled: true                           # 是否启用防盗链
      allowed-referers:                       # Referer白名单（域名列表）
        - localhost:8910                      # 后端服务（Swagger UI）
        - 127.0.0.1:8910                      # 后端服务（IP访问）
        - localhost:5174                      # 前端开发服务器（Vite默认端口）
        - 127.0.0.1:5174                      # 前端开发服务器（IP访问）
        - localhost:3000                      # 前端开发服务器（备用端口）
        - 127.0.0.1:3000                      # 前端开发服务器（备用端口）
        - music.example.com                   # 生产环境域名
      allow-empty-referer: true               # 是否允许空Referer（直接访问）
      blocked-user-agents:                    # User-Agent黑名单（正则表达式）
        - ".*[Pp]ython.*"                     # Python爬虫
        - ".*wget.*"                          # wget下载工具
        - ".*curl.*"                          # curl命令行工具
        - ".*[Ss]crapy.*"                     # Scrapy爬虫框架
        - ".*[Bb]ot.*"                        # 通用爬虫（Bot）
        - ".*[Ss]pider.*"                     # 通用爬虫（Spider）

    # 黑名单配置
    blacklist:
      ips: []                                 # 固定黑名单IP列表（可选）
      ban-duration-minutes: 30                # 动态黑名单封禁时长（分钟）
      cleanup-interval-minutes: 10            # 清理过期数据的间隔（分钟）
```

---

### 附录B：依赖版本信息

| 依赖 | 版本 | 用途 |
|------|------|------|
| Guava | 32.1.3-jre | RateLimiter 限流 |
| Hutool | 5.8.32 | Java工具库（支持Jakarta Servlet） |
| Spring Boot | 3.1.0 | 基础框架 |
| JDK | 17 | 运行环境 |

---

### 附录C：项目文件结构

```
src/main/java/com/naruto/wangyiyunmusic/
├── config/
│   └── properties/
│       └── AudioSecurityProperties.java    # 音频安全配置类（新增）
├── exception/
│   ├── RateLimitException.java             # 限流异常（新增）
│   ├── AntiLeechException.java             # 防盗链异常（新增）
│   └── GlobalExceptionHandler.java         # 全局异常处理器（修改）
├── filter/
│   ├── AudioRateLimitFilter.java           # 音频限流过滤器（新增）
│   └── AntiLeechFilter.java                # 防盗链过滤器（新增）
├── service/
│   ├── AudioRateLimitService.java          # 音频限流服务（新增）
│   └── AntiLeechService.java               # 防盗链服务（新增）
└── WangyiyunMusicApplication.java          # 主应用类（修改，添加@EnableScheduling）

说明：
- 工具类使用 Hutool 库（JakartaServletUtil、StrUtil等）
- 已移除自定义工具类（IpUtils、HttpRequestUtils）
- 配置类移至 config/properties 包下
```

---

### 附录D：相关文档链接

- [Guava RateLimiter 官方文档](https://github.com/google/guava/wiki/RateLimiterExplained)
- [Hutool 官方文档](https://doc.hutool.cn/)
- [Hutool Servlet工具](https://doc.hutool.cn/pages/ServletUtil/)
- [Spring Filter 官方文档](https://docs.spring.io/spring-framework/reference/web/webmvc/filters.html)
- [阿里巴巴 Java 开发手册](https://github.com/alibaba/p3c)
- [HTTP Range 请求规范（RFC 7233）](https://tools.ietf.org/html/rfc7233)

---

**文档状态**: ✅ 已完成实施
**实施时间**: 2026-01-31
**下一步**: 功能已上线，可进行测试和监控

---

## 实施完成记录

### 实施概况

**实施日期**: 2026-01-31
**实施方式**: 按照方案A（轻量级实现）完整实施 Phase 1 + Phase 2
**实施结果**: ✅ 所有功能已实现并通过编译验证

### 已采用的方案

根据推荐方案，做出以下决策：

1. **带宽控制**: ❌ 暂不实现（方案A）
2. **管理API**: ❌ 暂不实现（方案A）
3. **分布式限流**: ✅ 保持内存实现（方案A）
4. **日志详细程度**: ✅ 平衡模式（方案A）
5. **工具库选择**: ✅ 使用 Hutool 5.8.32 代替自定义工具类

### 实施成果

#### 阶段1：依赖配置与基础架构 ✅

- ✅ 添加 Guava 依赖（版本: 32.1.3-jre）
- ✅ 添加 Hutool 依赖（版本: 5.8.32，支持 Jakarta Servlet）
- ✅ 创建 `AudioSecurityProperties` 配置类
- ✅ 更新 `application.yaml` 音频安全配置
- ✅ 创建 `RateLimitException` 异常类
- ✅ 创建 `AntiLeechException` 异常类
- ✅ 更新 `GlobalExceptionHandler` 添加异常处理

#### 阶段2：智能限流功能实现 ✅

- ✅ 创建 `AudioRateLimitService` 智能限流服务
  - ✅ 基于IP的滑动窗口限流
  - ✅ Range请求限流（100次/分钟/IP）
  - ✅ 完整下载限流（5次/分钟/IP）
  - ✅ 不同文件数限流（10个/分钟/IP）
  - ✅ 并发连接数控制（3个/IP）
  - ✅ 动态黑名单机制（20次违规触发，封禁30分钟）
  - ✅ 定时清理过期数据（每10分钟）
- ✅ 在主应用类添加 `@EnableScheduling` 注解

#### 阶段3：防盗链功能实现 ✅

- ✅ 创建 `AntiLeechService` 防盗链服务
  - ✅ Referer 白名单检查（使用 Hutool StrUtil）
  - ✅ User-Agent 黑名单检查（使用 Hutool StrUtil）
  - ✅ IP 黑名单检查

#### 阶段4：Filter 集成 ✅

- ✅ 创建 `AudioRateLimitFilter` 限流过滤器（@Order(2)）
  - 使用 `JakartaServletUtil.getClientIP()` 获取客户端IP
  - 使用 `StrUtil` 分析请求
- ✅ 创建 `AntiLeechFilter` 防盗链过滤器（@Order(1)）
  - 使用 `JakartaServletUtil.getClientIP()` 获取客户端IP
- ✅ 编译验证通过（95个源文件）

### 新增文件清单

#### 配置类（1个）
- `config/properties/AudioSecurityProperties.java`

#### 异常类（2个）
- `exception/RateLimitException.java`
- `exception/AntiLeechException.java`

#### 服务类（2个）
- `service/AudioRateLimitService.java`
- `service/AntiLeechService.java`

#### 过滤器（2个）
- `filter/AudioRateLimitFilter.java`
- `filter/AntiLeechFilter.java`

#### 修改文件（4个）
- `pom.xml`（添加Guava、Hutool依赖）
- `application.yaml`（添加音频安全配置）
- `exception/GlobalExceptionHandler.java`（添加异常处理方法）
- `WangyiyunMusicApplication.java`（添加@EnableScheduling注解）

**总计**: 新增7个文件，修改4个文件

### 技术实现亮点

1. **高性能限流算法**: 使用 Guava RateLimiter 实现令牌桶算法
2. **线程安全**: 所有数据结构使用 ConcurrentHashMap，保证并发安全
3. **智能黑名单**: 自动识别恶意IP并临时封禁，过期自动解封
4. **定时清理**: 防止内存泄漏，自动清理过期数据
5. **分层防护**: 防盗链 -> 限流 -> 静态资源，多层安全防护
6. **可配置化**: 所有阈值可在 application.yaml 配置，支持动态调整
7. **完善的日志**: 平衡模式日志，便于问题排查和监控
8. **工具库优化**: 使用 Hutool 库代替自定义工具类，提升代码可维护性

### Hutool 工具使用说明

项目使用 **Hutool 5.8.32** 版本，该版本支持 Jakarta Servlet API（适配 Spring Boot 3.x）。

**主要使用场景**:

1. **获取客户端IP**: `JakartaServletUtil.getClientIP(request)`
   - 自动处理代理场景（X-Forwarded-For、X-Real-IP等）
   - 替代自定义 IpUtils 工具类

2. **字符串处理**: `StrUtil`
   - `StrUtil.nullToDefault()`: 获取请求头，提供默认值
   - `StrUtil.isNotBlank()`: 判断Range请求
   - `StrUtil.subAfter()`: 提取文件名

**优势**:
- ✅ 无需维护自定义工具类
- ✅ 社区活跃，持续更新
- ✅ 完美支持 Jakarta Servlet API
- ✅ 提供丰富的工具方法

### 配置示例

默认配置已添加到 `application.yaml`：

```yaml
audio:
  security:
    rate-limit:
      enabled: true
      range-requests-per-minute: 100
      full-downloads-per-minute: 5
      unique-files-per-minute: 10
      max-concurrent-connections: 3
      blacklist-threshold: 20
      window-minutes: 5
    anti-leech:
      enabled: true
      allowed-referers:
        - localhost:8910                      # 后端服务
        - localhost:5174                      # 前端开发服务器（Vite）
        - localhost:3000                      # 前端开发服务器（备用）
        - music.example.com                   # 生产环境域名
      allow-empty-referer: true
      blocked-user-agents:
        - ".*[Pp]ython.*"
        - ".*wget.*"
        - ".*curl.*"
        - ".*[Ss]crapy.*"
        - ".*[Bb]ot.*"
        - ".*[Ss]pider.*"
    blacklist:
      ips: []
      ban-duration-minutes: 30
      cleanup-interval-minutes: 10
```

### 后续建议

#### 测试验证
建议执行以下测试用例：

1. **限流功能测试**：
   - 使用 `curl` 发送大量请求，验证限流触发
   - 测试 Range 请求和完整下载的不同限流策略

2. **防盗链测试**：
   - 使用不同的 Referer 和 User-Agent 测试拦截功能
   - 验证白名单和黑名单机制

3. **性能测试**：
   - 使用 JMeter 进行压力测试
   - 验证 Filter 处理时间 < 10ms

4. **集成测试**：
   - 验证正常用户播放体验不受影响
   - 测试拖拽播放、暂停、继续等功能

#### 监控建议
1. 定期查看日志中的限流和防盗链拦截记录
2. 监控内存使用情况（跟踪IP数量）
3. 统计限流触发次数和黑名单IP数量
4. 根据实际情况调整限流阈值

#### 优化方向
1. 如需支持多实例部署，可升级到 Redis 分布式限流
2. 可添加管理API，支持动态调整配置
3. 可集成 Prometheus + Grafana 实现可视化监控
4. 可添加带宽控制功能，进一步限制下载速度

---

**文档状态**: ✅ 已完成实施并同步更新
**实施时间**: 2026-01-31
**文档更新**: 2026-01-31（同步 Hutool 工具使用）
**下一步**: 功能已上线，可进行测试和监控
