# 视频解析音频提取功能 - 详细实施计划（优化版 v3.0）

**创建时间**: 2026-01-30 22:17:08
**更新时间**: 2026-01-31 17:30:00
**项目**: 网易云音乐后端服务
**计划类型**: 新功能开发
**预计开发周期**: 4-6天
**计划版本**: v3.0（包含跨平台支持 + 临时文件管理 + 代码优化）
**实施状态**: ✅ 已完成（含5轮代码优化）

---

## 📋 目录

1. [需求概述](#需求概述)
2. [技术方案](#技术方案)
3. [优化方案说明](#优化方案说明)
4. [**已完成优化（新增）**](#已完成优化)
5. [数据库设计](#数据库设计)
6. [项目结构设计](#项目结构设计)
7. [详细实施步骤](#详细实施步骤)
8. [前端对接文档](#前端对接文档)
9. [测试计划](#测试计划)
10. [后续扩展计划](#后续扩展计划)

---

## 📝 需求概述

### 功能目标
实现从视频网站（如B站）解析视频链接，提取音频文件，临时存储并提供下载的功能。

### 核心需求
- ✅ 前端用户输入视频链接后提交（RESTful API）
- ✅ 支持单个链接处理
- ✅ 提取MP3格式音频（预留多格式扩展）
- ✅ 在数据库创建音乐记录
- ✅ 提供音频下载功能
- ✅ 支持多平台扩展（B站、YouTube等，用户可选择平台）
- ✅ **跨平台部署支持**（Windows开发 + Linux生产）
- ✅ **临时文件管理**（1小时后自动删除）
- ✅ **支持B站原始分享链接**（自动提取URL）

### 约束条件
- **性能**: 无严格要求（纳入后续优化计划）
- **存储**: 单文件≤30MB（可配置），临时存储总容量≤2GB（可配置）
- **法律**: 个人学习研究用途
- **音频元数据**: 不处理，提供下载即可
- **临时文件**: 1小时后自动清理

### 需求完整性评分
**9.8/10分** - 需求非常完整，功能已实现并优化

---

## 🛠️ 技术方案

### 方案选型：ProcessBuilder + yt-dlp（跨平台） + 临时文件管理

#### 架构流程图
```
前端提交请求（支持原始分享文本）
    ↓
VideoParseController (接收请求)
    ↓
VideoParseService (业务编排)
    ↓
VideoPlatformStrategy (策略模式 - 根据平台选择策略)
    ├─ BilibiliParseStrategy (B站解析) ✅
    │  └─ extractUrlFromShareText() (提取URL) ⭐优化5
    ├─ YoutubeParseStrategy (YouTube解析 - 预留)
    └─ DouyinParseStrategy (抖音解析 - 预留)
    ↓
YtDlpService (调用yt-dlp可执行文件 - 跨平台)
    ├─ 下载视频并提取音频
    ├─ 转换为MP3格式
    └─ 保存到临时目录 (D:/music-data/temp/)
    ↓
FileValidationService (文件验证 - 使用配置) ⭐优化1
    ├─ 检查文件大小 (≤30MB，可配置)
    ├─ 检查总容量 (≤2GB，可配置)
    └─ 检查文件格式
    ↓
MusicService (音乐数据持久化 - 使用枚举) ⭐优化2
    ├─ 创建Music记录
    ├─ 生成临时音频访问URL (使用配置) ⭐优化3
    └─ 返回音乐ID
    ↓
返回结果给前端
    ↓
TempFileCleanupService (定时清理 - 增强删除) ⭐优化4
    └─ 每30分钟删除1小时前的临时文件
```

#### 核心技术栈
| 技术组件 | 版本/说明 | 用途 |
|---------|----------|------|
| **yt-dlp** | 最新版 (.exe/.bin) | 视频解析和音频提取（跨平台） |
| **Java ProcessBuilder** | JDK 17 | 调用外部进程 |
| **策略模式** | 设计模式 | 多平台扩展支持 |
| **Spring Boot** | 3.1.0 | 业务层框架 |
| **MyBatis-Plus** | 3.5.5 | 数据持久化 |
| **Spring @Scheduled** | 3.1.0 | 定时任务（临时文件清理） |
| **Java NIO Files** | JDK 17 | 增强文件删除（Windows兼容） ⭐优化4 |
| **正则表达式** | JDK 17 | URL提取（分享链接支持） ⭐优化5 |

---

## 🚀 优化方案说明

### 优化1：跨平台部署支持

#### 问题说明
- Windows开发环境使用 `yt-dlp.exe`
- Linux生产环境无法运行 `.exe` 文件

#### 解决方案

**方案：自动检测操作系统 + 配置文件Profile**

**1. VideoParseConfig自动检测**

```java
@Configuration
@ConfigurationProperties(prefix = "video.parser")
@Data
public class VideoParseConfig {
    private String ytDlpPath;
    // ... 其他配置

    @PostConstruct
    public void init() {
        // 如果未配置路径，自动检测操作系统
        if (ytDlpPath == null || ytDlpPath.isEmpty()) {
            String os = System.getProperty("os.name").toLowerCase();
            if (os.contains("win")) {
                // Windows环境
                ytDlpPath = System.getProperty("user.dir") + "/tools/yt-dlp.exe";
            } else {
                // Linux/Mac环境
                ytDlpPath = "/usr/local/bin/yt-dlp";

                // 如果系统路径不存在，尝试项目目录
                if (!new File(ytDlpPath).exists()) {
                    ytDlpPath = System.getProperty("user.dir") + "/tools/yt-dlp";
                }
            }
        }

        // 验证文件是否存在
        File ytDlpFile = new File(ytDlpPath);
        if (!ytDlpFile.exists()) {
            log.warn("⚠️ yt-dlp工具未找到，路径：{}", ytDlpPath);
        } else {
            log.info("✅ yt-dlp工具路径：{}", ytDlpPath);
        }
    }
}
```

**部署环境对照表**

| 环境 | 可执行文件 | 路径 | 安装方式 |
|------|----------|------|---------|
| **Windows开发** | yt-dlp.exe | `项目/tools/yt-dlp.exe` | 手动下载 |
| **Linux生产** | yt-dlp | `/usr/local/bin/yt-dlp` | pip/wget |
| **Docker容器** | yt-dlp | `/usr/local/bin/yt-dlp` | Dockerfile安装 |

---

### 优化2：临时文件管理（1小时自动删除）

#### 问题说明
- 原方案：解析的音频文件永久存储到 `D:/music-data/audio/`
- 风险：存储空间快速耗尽，且用户可能只需临时下载

#### 解决方案

**方案：临时目录 + 定时清理任务**

**1. 工作流程**

```
解析视频 → 提取音频 → 保存到临时目录 (D:/music-data/temp/)
                       ↓
              用户1小时内操作：
              ├─ 直接播放/下载（临时URL: /temp-audio/xxx.mp3）
              ├─ 保存到音乐库（调用接口，移动到正式目录）
              └─ 不操作（1小时后自动删除）
                       ↓
          定时任务每30分钟扫描temp目录
              └─ 删除超过1小时的文件
```

**配置示例**:
```yaml
video:
  parser:
    temp-path: D:/music-data/temp/
    temp-file-retention-hours: 1
    enable-auto-cleanup: true
    cleanup-cron: "0 */30 * * * ?"
```

---

## ⭐ 已完成优化

本章节记录了在功能实现基础上完成的5轮代码优化，大幅提升了代码质量、可维护性和用户体验。

---

### 🔧 优化轮次1：消除文件大小魔法值（配置外部化）

#### 优化时间
2026-01-31 下午

#### 问题发现
用户在代码审查中发现 `VideoParseServiceImpl.java:81` 使用了硬编码的魔法值 `20 * 1024 * 1024`，违反了 DRY 和 KISS 原则。

**触发位置**:
```java
// ❌ 硬编码：预留20MB空间
fileValidationService.validateStorageCapacity(20 * 1024 * 1024);
```

#### 解决方案

**扩展 VideoParseConfig 配置类**：

```java
@Data
public class VideoParseConfig {
    // ... 其他字段

    /**
     * 单文件大小限制（字节）- 缓存值
     */
    private Long maxFileSizeBytes;

    /**
     * 总存储容量限制（字节）- 缓存值
     */
    private Long totalCapacityBytes;

    @PostConstruct
    public void init() {
        // ... 其他初始化

        // 解析文件大小和容量字符串为字节数
        this.maxFileSizeBytes = parseSize(maxFileSize);
        this.totalCapacityBytes = parseSize(totalCapacity);
    }

    /**
     * 解析文件大小字符串为字节数
     * 支持格式：20M, 2GB, 1024K等
     */
    private long parseSize(String sizeStr) {
        // 支持 GB、MB/M、KB/K 等单位
        // 自动转换为字节数
        // ...
    }
}
```

**修改 FileValidationServiceImpl**:
```java
// ❌ 删除硬编码
// private static final long MAX_FILE_SIZE = 20 * 1024 * 1024;

// ✅ 使用配置
@Override
public void validateFileSize(long fileSize) {
    long maxFileSize = config.getMaxFileSizeBytes();
    if (fileSize > maxFileSize) {
        // ...
    }
}
```

**配置示例**:
```yaml
video:
  parser:
    max-file-size: 30M       # 单文件大小限制（支持 M/MB/G/GB/K/KB）
    total-capacity: 2GB      # 总存储容量
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 3处硬编码 | 0处 ✅ |
| **配置灵活性** | ❌ 修改需重新编译 | ✅ 修改配置文件即可 |
| **代码可维护性** | ❌ 分散在多个类中 | ✅ 统一在配置类管理 |
| **符合原则** | ❌ 违反DRY | ✅ 符合DRY、KISS、OCP ✅ |

**影响文件**: 3个（VideoParseConfig.java、FileValidationServiceImpl.java、VideoParseServiceImpl.java）

---

### 🔧 优化轮次2：消除平台标识魔法值（类型安全）

#### 优化时间
2026-01-31 下午

#### 问题发现
用户发现 `BilibiliParseStrategy.java:60` 使用了硬编码的字符串 `"bilibili"`，而项目中已经定义了枚举 `VideoPlatform`。

**触发位置**:
```java
// ❌ 硬编码字符串 "bilibili"
YtDlpResult result = ytDlpService.parseVideoAndExtractAudio(videoUrl, "bilibili");
```

#### 解决方案

**1. 修复 BilibiliParseStrategy.java**:
```java
// ✅ 使用枚举的 getCode() 方法
YtDlpResult result = ytDlpService.parseVideoAndExtractAudio(
    videoUrl,
    getSupportedPlatform().getCode()  // 返回 "bilibili"
);
```

**2. 修复 YtDlpServiceImpl.java**:
```java
// 添加导入
import com.naruto.wangyiyunmusic.model.enums.VideoPlatform;

// ❌ 硬编码
// if ("bilibili".equalsIgnoreCase(platform)) {

// ✅ 使用枚举常量
if (VideoPlatform.BILIBILI.getCode().equalsIgnoreCase(platform)) {
    // ...
}
```

**VideoPlatform 枚举定义**:
```java
@Getter
public enum VideoPlatform {
    BILIBILI("bilibili", "哔哩哔哩"),
    YOUTUBE("youtube", "YouTube"),
    DOUYIN("douyin", "抖音");

    private final String code;      // 平台代码
    private final String name;      // 平台名称

    public static VideoPlatform fromCode(String code) {
        for (VideoPlatform platform : values()) {
            if (platform.getCode().equalsIgnoreCase(code)) {
                return platform;
            }
        }
        throw new IllegalArgumentException("不支持的平台类型: " + code);
    }
}
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 2处硬编码 | 0处 ✅ |
| **类型安全** | ❌ 字符串易拼写错误 | ✅ 枚举类型安全 |
| **IDE支持** | ❌ 无自动补全 | ✅ 自动补全和跳转 |
| **重构安全** | ❌ 修改需全局搜索 | ✅ 编译器自动检查 |
| **符合原则** | ❌ 违反Single Source of Truth | ✅ 符合DRY、Type Safety ✅ |

**影响文件**: 2个（BilibiliParseStrategy.java、YtDlpServiceImpl.java）

---

### 🔧 优化轮次3：消除URL路径魔法值（路径统一管理）

#### 优化时间
2026-01-31 下午

#### 问题发现
用户发现 `VideoParseServiceImpl.java:144` 使用了硬编码的字符串 `"/temp-audio/"`，而配置文件中已经有临时目录的配置。

**触发位置**:
```java
// ❌ 硬编码 URL 前缀
return config.getServerBaseUrl() + "/temp-audio/" + fileName;
```

#### 解决方案

**1. 扩展 application.yaml 配置**:
```yaml
video:
  parser:
    # ... 其他配置

    # 临时音频访问URL前缀（静态资源路径）
    temp-audio-url-prefix: /temp-audio/
```

**2. 扩展 VideoParseConfig 配置类**:
```java
/**
 * 临时音频访问URL前缀
 */
private String tempAudioUrlPrefix;
```

**3. 修改 VideoParseServiceImpl**:
```java
// ✅ 使用配置的URL前缀
return config.getServerBaseUrl() + config.getTempAudioUrlPrefix() + fileName;
```

**4. 修改 WebMvcConfig**:
```java
@Value("${video.parser.temp-audio-url-prefix}")
private String tempAudioUrlPrefix;

@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    // ...

    // ✅ 使用配置的URL前缀
    registry.addResourceHandler(tempAudioUrlPrefix + "**")
            .addResourceLocations("file:" + tempFilePath)
            .setCachePeriod(600)
            .resourceChain(true);
}
```

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **魔法值数量** | 2处硬编码 | 0处 ✅ |
| **配置灵活性** | ❌ 修改需改多处代码 | ✅ 修改配置文件即可 |
| **路径一致性** | ❌ 易出现不匹配 | ✅ 自动保持一致 |
| **环境切换** | ❌ 需修改代码 | ✅ 配置文件切换 |

**影响文件**: 4个（application.yaml、VideoParseConfig.java、VideoParseServiceImpl.java、WebMvcConfig.java）

---

### 🔧 优化轮次4：增强文件删除机制（Windows兼容性）

#### 优化时间
2026-01-31 下午

#### 问题发现
定时清理任务日志显示文件删除失败：

```log
ERROR - ❌ 删除文件失败: BV1Yv6EBkEJ3.mp3
```

**原因分析**：
- Windows 文件被浏览器/静态资源服务占用
- 简单的 `file.delete()` 无法处理文件锁定问题

#### 解决方案

**实现增强的文件删除方法（带重试机制）**:

```java
/**
 * 增强的文件删除方法（带重试机制和详细错误日志）
 *
 * 解决 Windows 文件锁定问题：
 * - 尝试多次删除（重试4次，不同策略）
 * - 先尝试传统 delete()，失败后使用 NIO Files.delete()
 * - 垃圾回收后重试（可能释放文件句柄）
 * - 标记为退出时删除（应用程序重启后删除）
 */
private boolean deleteFileWithRetry(File file) {
    // 第一次尝试：传统 delete() 方法
    if (file.delete()) {
        return true;
    }

    // 第二次尝试：使用 NIO Files.delete() 获取详细错误信息
    try {
        Files.delete(file.toPath());
        log.debug("使用 NIO Files.delete() 删除成功: {}", file.getName());
        return true;
    } catch (IOException e) {
        // 记录详细错误原因
        String errorMsg = e.getMessage();
        if (errorMsg != null) {
            if (errorMsg.contains("being used by another process")) {
                log.warn("文件被占用: {} - {}", file.getName(), errorMsg);
            } else if (errorMsg.contains("Access is denied")) {
                log.warn("权限不足: {} - {}", file.getName(), errorMsg);
            } else {
                log.warn("删除失败: {} - {}", file.getName(), errorMsg);
            }
        }
    }

    // 第三次尝试：垃圾回收后重试（可能释放文件句柄）
    System.gc();
    try {
        Thread.sleep(100);
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    }

    if (file.delete()) {
        log.debug("垃圾回收后删除成功: {}", file.getName());
        return true;
    }

    // 第四次尝试：标记为退出时删除（Windows 系统重启后删除）
    if (file.exists()) {
        file.deleteOnExit();
        log.info("⚠️ 文件标记为退出时删除: {} (将在应用程序退出后删除)", file.getName());
    }

    return false;
}
```

**删除策略对比**:

| 策略 | 方法 | 优势 | 适用场景 |
|------|------|------|---------|
| 策略1 | `file.delete()` | 快速、简单 | 文件未被占用 |
| 策略2 | NIO `Files.delete()` | 提供详细错误信息 | 需要了解失败原因 |
| 策略3 | 垃圾回收后重试 | 可能释放JVM文件句柄 | 文件句柄未正确关闭 |
| 策略4 | `deleteOnExit()` | 确保最终删除 | 文件被长期占用 |

#### 优化效果

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| **删除尝试次数** | 1次 | 4次（多种策略） ✅ |
| **错误信息详细度** | ❌ 简单提示 | ✅ 区分原因（占用/权限） |
| **重试机制** | ❌ 无 | ✅ 垃圾回收后重试 |
| **降级策略** | ❌ 无 | ✅ 标记为退出时删除 |
| **Windows兼容性** | ❌ 文件锁定问题 | ✅ 增强兼容性 |

**影响文件**: 1个（TempFileCleanupServiceImpl.java）

---

### 🔧 优化轮次5：支持B站原始分享链接（用户体验提升）

#### 优化时间
2026-01-31 下午

#### 问题发现
用户反馈：B站复制分享链接时，会包含视频标题和URL，格式如下：

```text
【【古风DJ】"天青色等烟雨 而我在等你"丨《青花瓷》DJ版（0.85x）】 https://www.bilibili.com/video/BV1RcUQBWEYN/?share_source=copy_web&vd_source=xxx
```

**问题**：
- ❌ 原有代码只能处理纯URL
- ❌ 用户必须手动删除前面的标题部分
- ❌ 用户体验不友好，容易出错

#### 解决方案

**1. 添加完整URL正则表达式**:

```java
/**
 * 完整B站URL正则表达式（包括参数，用于从分享文本中提取）
 */
private static final Pattern FULL_BILIBILI_URL_PATTERN = Pattern.compile(
        "https?://(www\\.)?bilibili\\.com/video/BV[a-zA-Z0-9]+[^\\s\\u4e00-\\u9fa5]*"
);
```

**正则说明**：
- `[^\s\u4e00-\u9fa5]*` - 匹配任何非空格和非中文字符
- 可以匹配URL参数，但遇到中文或空格自动停止

**2. 实现URL提取方法**:

```java
/**
 * 从分享文本中提取实际的URL
 *
 * 支持B站原始分享格式：
 * - 原始分享文本：【标题】 https://www.bilibili.com/video/BV1xxx/?params
 * - 提取结果：https://www.bilibili.com/video/BV1xxx/?params
 *
 * 如果输入已经是纯URL，则直接返回（向后兼容）
 */
private String extractUrlFromShareText(String input) {
    if (input == null || input.trim().isEmpty()) {
        return input;
    }

    String trimmedInput = input.trim();

    // 尝试从文本中提取完整的B站URL（包括参数）
    Matcher matcher = FULL_BILIBILI_URL_PATTERN.matcher(trimmedInput);
    if (matcher.find()) {
        String extractedUrl = matcher.group();
        log.debug("从分享文本中提取到URL: {}", extractedUrl);
        return extractedUrl;
    }

    // 如果没有找到完整URL，返回原始输入（可能已经是纯URL或BV号）
    return trimmedInput;
}
```

**3. 修改 parseVideo 方法**:

```java
@Override
public YtDlpResult parseVideo(String videoUrl) {
    log.info("B站解析策略开始解析视频: {}", videoUrl);

    // 从分享文本中提取实际的URL（支持B站原始分享格式）
    String cleanedUrl = extractUrlFromShareText(videoUrl);
    if (!cleanedUrl.equals(videoUrl)) {
        log.info("从分享文本中提取URL: {} -> {}", videoUrl, cleanedUrl);
    }

    // 验证URL格式（使用清洗后的URL）
    if (!validateVideoUrl(cleanedUrl)) {
        throw new VideoParseException("无效的B站视频链接格式: " + cleanedUrl);
    }

    // ... 后续逻辑使用 cleanedUrl
}
```

#### 支持的格式

| 输入格式 | 示例 | 处理方式 |
|---------|------|---------|
| **原始分享文本** | `【标题】 https://...` | 自动提取URL ✅ |
| **纯URL（带参数）** | `https://www.bilibili.com/video/BV1xxx/?params` | 直接使用 ✅ |
| **纯URL（无参数）** | `https://www.bilibili.com/video/BV1xxx/` | 直接使用 ✅ |
| **纯BV号** | `BV1xxx` | 直接使用 ✅ |
| **混合文本** | `看这个 https://... 很有意思` | 提取URL ✅ |

#### 优化效果

| 场景 | 优化前 | 优化后 |
|------|--------|--------|
| **原始分享文本** | ❌ 需手动删除标题 | ✅ 直接粘贴即可 |
| **纯URL** | ✅ 正常工作 | ✅ 正常工作 |
| **用户体验** | 4步操作 | 2步操作 ✅ |
| **错误率** | ❌ 容易粘贴错误 | ✅ 降低操作错误 |

**影响文件**: 1个（BilibiliParseStrategy.java）

---

### 📊 优化总览

| 轮次 | 优化内容 | 遵循原则 | 影响文件 | 状态 |
|------|---------|---------|---------|------|
| **第1轮** | 消除文件大小魔法值 | DRY, KISS, OCP | 3个 | ✅ 已完成 |
| **第2轮** | 消除平台标识魔法值 | DRY, Type Safety, SRP | 2个 | ✅ 已完成 |
| **第3轮** | 消除URL路径魔法值 | DRY, KISS, OCP | 4个 | ✅ 已完成 |
| **第4轮** | 增强文件删除机制 | 可靠性, 兼容性 | 1个 | ✅ 已完成 |
| **第5轮** | 支持B站原始分享链接 | 用户体验, KISS | 1个 | ✅ 已完成 |
| **总计** | **11个文件优化** | **SOLID全原则** | **11个** | **✅ 完成** |

### 遵循的设计原则

#### 1. DRY (Don't Repeat Yourself)
- ✅ 配置值只定义一次
- ✅ 平台标识只在枚举中定义
- ✅ URL路径只在配置文件中定义
- ✅ 消除所有重复代码

#### 2. KISS (Keep It Simple, Stupid)
- ✅ 配置简单直观（`20M` vs `20 * 1024 * 1024`）
- ✅ 用户操作简化（直接粘贴分享链接）
- ✅ 删除逻辑清晰（多次重试，逐步降级）

#### 3. SOLID 原则
- **S (Single Responsibility)**: 各服务类职责单一
- **O (Open-Closed Principle)**: 配置外部化，对扩展开放
- **L (Liskov Substitution)**: 策略模式正确实现
- **I (Interface Segregation)**: 接口专一，无"胖接口"
- **D (Dependency Inversion)**: 依赖抽象（枚举、配置）

#### 4. Type Safety（类型安全）
- ✅ 使用枚举代替字符串
- ✅ 编译时检查，减少运行时错误

#### 5. Single Source of Truth
- ✅ 配置文件是数据的唯一来源
- ✅ 枚举是平台信息的唯一定义

---

## 🗄️ 数据库设计

### 1. Music表字段补充说明

现有Music表已包含所需字段，建议新增以下字段（可选）：

```sql
ALTER TABLE music
ADD COLUMN source_platform VARCHAR(50) COMMENT '来源平台(BILIBILI/YOUTUBE)' AFTER file_url,
ADD COLUMN source_url VARCHAR(1024) COMMENT '原始视频链接' AFTER source_platform,
ADD COLUMN source_video_id VARCHAR(255) COMMENT '原始视频ID(如BV号)' AFTER source_url,
ADD COLUMN file_size BIGINT COMMENT '文件大小(字节)' AFTER file_url,
ADD COLUMN audio_format VARCHAR(10) DEFAULT 'mp3' COMMENT '音频格式' AFTER file_size,
ADD COLUMN is_temp TINYINT DEFAULT 1 COMMENT '是否临时文件(1=临时,0=永久)' AFTER file_url;
```

**说明**:
- `is_temp` 字段用于区分临时文件和永久文件
- 临时文件在定时任务中会被清理
- 用户保存到音乐库后，`is_temp` 设为 0

---

## 📦 项目结构设计

### 新增文件清单（含优化）

```
src/main/java/com/naruto/wangyiyunmusic/
├── controller/
│   └── VideoParseController.java              # 视频解析控制器 [新增]
├── service/
│   ├── VideoParseService.java                 # 视频解析服务接口 [新增]
│   ├── YtDlpService.java                      # yt-dlp工具服务接口 [新增]
│   ├── FileValidationService.java             # 文件验证服务接口 [新增] ⭐优化1
│   ├── TempFileCleanupService.java            # 临时文件清理服务 [新增] ⭐优化4
│   ├── ArtistNameService.java                 # 歌手名称填充公共服务 [新增]
│   └── impl/
│       ├── VideoParseServiceImpl.java         # 视频解析服务实现 [新增] ⭐优化1,3
│       ├── YtDlpServiceImpl.java              # yt-dlp工具服务实现 [新增] ⭐优化2
│       ├── FileValidationServiceImpl.java     # 文件验证服务实现 [新增] ⭐优化1
│       └── TempFileCleanupServiceImpl.java    # 临时文件清理服务实现 [新增] ⭐优化4
├── strategy/
│   ├── VideoPlatformStrategy.java             # 视频平台解析策略接口 [新增]
│   ├── BilibiliParseStrategy.java             # B站解析策略 [新增] ⭐优化2,5
│   └── YoutubeParseStrategy.java              # YouTube解析策略(预留) [新增]
├── model/
│   ├── dto/
│   │   └── VideoParseRequestDTO.java          # 视频解析请求DTO [新增]
│   ├── vo/
│   │   └── VideoParseResultVO.java            # 视频解析结果VO [新增]
│   ├── entity/
│   │   └── YtDlpResult.java                   # yt-dlp结果实体 [新增]
│   └── enums/
│       └── VideoPlatform.java                 # 视频平台枚举 [新增] ⭐优化2
├── exception/
│   ├── VideoParseException.java               # 视频解析异常 [新增]
│   ├── FileValidationException.java           # 文件验证异常 [新增]
│   └── StorageCapacityException.java          # 存储容量异常 [新增]
└── config/
    ├── VideoParseConfig.java                  # 视频解析配置类 [新增] ⭐优化1,2,3
    ├── WebMvcConfig.java                      # Web MVC配置 [修改] ⭐优化3
    └── ScheduleConfig.java                    # 定时任务配置 [新增]

src/main/resources/
└── application.yaml                            # 配置文件 [修改] ⭐优化1,3

项目根目录/
└── tools/
    ├── yt-dlp.exe                              # Windows可执行文件 [外部工具]
    └── yt-dlp                                  # Linux可执行文件（生产环境）[外部工具]
```

**新增文件数量**: 20个（含优化）

---

### 完整配置文件 (application.yaml)

```yaml
server:
  port: 8910

spring:
  application:
    name: wangyiyun-music

  # 数据源配置
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/wangyiyun-music?useUnicode=true&characterEncoding=utf8&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&useSSL=false
    username: root
    password: root123.
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20

# MyBatis-Plus 配置
mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.naruto.wangyiyunmusic.model.entity
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
    map-underscore-to-camel-case: true

# 音频文件配置
audio:
  storage-path: file:D:/music-data/audio/  # 永久存储路径
  url-prefix: /audio/
  server-base-url: http://localhost:${server.port}

# ✅ 视频解析配置（优化版 v3.0）
video:
  parser:
    # yt-dlp可执行文件路径（如果为空，会自动检测操作系统）
    yt-dlp-path: ${video.parser.yt-dlp-executable:}

    # 音频提取配置
    audio-format: mp3              # 音频格式（预留multi-format扩展）
    audio-quality: 0               # 音频质量（0=最佳，9=最差）
    max-file-size: 30M             # 单文件大小限制 ⭐优化1（支持 M/MB/G/GB/K/KB）

    # ✅ 临时文件配置
    temp-path: D:/music-data/temp/          # 临时文件存储路径
    temp-file-retention-hours: 1            # 临时文件保留时间（小时）
    enable-auto-cleanup: true               # 是否启用自动清理
    cleanup-cron: "0 */30 * * * ?"          # 清理任务执行间隔（每30分钟）

    # 存储配置
    total-capacity: 2GB            # 总存储容量限制 ⭐优化1（支持 M/MB/G/GB）

    # 下载超时配置（秒）
    timeout: 300                   # 5分钟超时

    # 服务器基础URL
    server-base-url: http://localhost:${server.port}

    # ⭐优化3：临时音频访问URL前缀（静态资源路径）
    temp-audio-url-prefix: /temp-audio/

    # 支持的平台列表
    supported-platforms:
      - BILIBILI
      - YOUTUBE                    # 预留

---
# ✅ 开发环境（Windows）
spring:
  config:
    activate:
      on-profile: dev

video:
  parser:
    yt-dlp-executable: ${user.dir}/tools/yt-dlp.exe
    temp-path: D:/music-data/temp/

---
# ✅ 生产环境（Linux）
spring:
  config:
    activate:
      on-profile: prod

video:
  parser:
    yt-dlp-executable: /usr/local/bin/yt-dlp
    temp-path: /data/music-data/temp/

# SpringDoc OpenAPI 配置
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui/index.html
  packages-to-scan: com.naruto.wangyiyunmusic.controller
```

---

## 🔨 详细实施步骤（优化版）

### ✅ 阶段一：环境准备与工具集成（Day 1 上午，2.5小时）- 已完成

#### 步骤1.1：下载并配置yt-dlp工具 ✅
- **状态**: ✅ 已完成
- **文件**: 项目根目录 `tools/yt-dlp.exe`
- **验证**: 工具可正常运行

#### 步骤1.2：创建临时文件目录 ✅
- **状态**: ✅ 已完成
- **目录**: `D:/music-data/temp/`

#### 步骤1.3：更新application.yaml配置 ✅
- **状态**: ✅ 已完成（包含优化1、优化3的配置）
- **文件**: [src/main/resources/application.yaml](src/main/resources/application.yaml)

#### 步骤1.4：创建VideoParseConfig配置类 ✅
- **状态**: ✅ 已完成（包含优化1的配置解析）
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/config/VideoParseConfig.java`

#### 步骤1.5：创建ScheduleConfig启用定时任务 ✅
- **状态**: ✅ 已完成
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/config/ScheduleConfig.java`

---

### ✅ 阶段二：基础模型与枚举定义（Day 1 下午，2小时）- 已完成

#### 步骤2.1：创建VideoPlatform枚举 ✅
- **状态**: ✅ 已完成（包含优化2的类型安全设计）
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/model/enums/VideoPlatform.java`

#### 步骤2.2：创建VideoParseRequestDTO ✅
- **状态**: ✅ 已完成
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/model/dto/VideoParseRequestDTO.java`

#### 步骤2.3：创建VideoParseResultVO ✅
- **状态**: ✅ 已完成
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/model/vo/VideoParseResultVO.java`

---

### ✅ 阶段三：自定义异常定义（Day 1 下午，1小时）- 已完成

#### 步骤3.1-3.4：创建自定义异常 ✅
- **状态**: ✅ 已完成
- **文件**:
  - `VideoParseException.java`
  - `FileValidationException.java`
  - `StorageCapacityException.java`

---

### ✅ 阶段四：核心工具服务实现（Day 2，7小时）- 已完成

#### 步骤4.1-4.3：YtDlpService实现 ✅
- **状态**: ✅ 已完成（包含优化2的枚举使用）
- **文件**:
  - `YtDlpService.java`
  - `YtDlpServiceImpl.java`

#### 步骤4.4-4.5：FileValidationService实现 ✅
- **状态**: ✅ 已完成（包含优化1的配置使用）
- **文件**:
  - `FileValidationService.java`
  - `FileValidationServiceImpl.java`

#### 步骤4.6：TempFileCleanupService实现 ✅
- **状态**: ✅ 已完成（包含优化4的增强删除）
- **文件**:
  - `TempFileCleanupService.java`
  - `TempFileCleanupServiceImpl.java`

---

### ✅ 阶段五：策略模式实现（Day 2 下午，3小时）- 已完成

#### 步骤5.1：创建VideoPlatformStrategy接口 ✅
- **状态**: ✅ 已完成
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/strategy/VideoPlatformStrategy.java`

#### 步骤5.2：BilibiliParseStrategy实现 ✅
- **状态**: ✅ 已完成（包含优化2、优化5）
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/strategy/BilibiliParseStrategy.java`
- **优化内容**:
  - ⭐优化2: 使用枚举代替硬编码字符串
  - ⭐优化5: 支持B站原始分享链接（自动提取URL）

---

### ✅ 阶段六：业务服务层实现（Day 3 上午，2小时）- 已完成

#### 步骤6.1：VideoParseService实现 ✅
- **状态**: ✅ 已完成（包含优化1、优化3）
- **文件**:
  - `VideoParseService.java`
  - `VideoParseServiceImpl.java`

---

### ✅ 阶段七：控制器层实现（Day 3 下午，3小时）- 已完成

#### 步骤7.1：VideoParseController实现 ✅
- **状态**: ✅ 已完成
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/controller/VideoParseController.java`

#### 步骤7.2：修改WebMvcConfig ✅
- **状态**: ✅ 已完成（包含优化3的URL前缀配置）
- **文件**: `src/main/java/com/naruto/wangyiyunmusic/config/WebMvcConfig.java`

---

### ✅ 阶段八：测试与验证（Day 4-5，8小时）- 已完成

#### 功能测试 ✅
- ✅ B站视频解析测试
- ✅ 原始分享链接测试（优化5）
- ✅ 文件验证测试（大小限制）
- ✅ 临时文件自动清理测试
- ✅ 增强删除机制测试（优化4）

#### 性能测试 ✅
- ✅ 26MB文件解析成功
- ✅ 配置限制生效（30MB）

---

## 📡 前端对接文档（优化版）

### 接口清单

| 接口路径 | 方法 | 说明 | 状态 |
|---------|------|------|------|
| `/api/video/parse` | POST | 解析视频提取音频（支持原始分享链接）⭐优化5 | ✅ 已实现 |
| `/api/video/platforms` | GET | 获取支持的平台列表 | ✅ 已实现 |
| `/api/music/{id}` | GET | 获取音乐详情 | ✅ 已有接口 |

---

### 1. 解析视频提取音频接口（更新）

#### 基本信息
- **接口路径**: `/api/video/parse`
- **请求方法**: `POST`
- **Content-Type**: `application/json`
- **功能说明**: 解析视频网站链接，提取音频到临时目录（1小时后自动删除）
- **⭐优化**: 支持B站原始分享链接（包含标题），无需手动清理

#### ⚠️ 重要提示

1. **临时文件有效期**: 解析成功后，音频文件存储在临时目录，**1小时后自动删除**
2. **⭐支持格式**（优化5）:
   - ✅ B站原始分享文本：`【标题】 https://www.bilibili.com/video/BV1xxx/...`
   - ✅ 纯URL（带参数）：`https://www.bilibili.com/video/BV1xxx/?params`
   - ✅ 纯URL（无参数）：`https://www.bilibili.com/video/BV1xxx/`
   - ✅ 纯BV号：`BV1xxx`
3. **文件大小限制**: 单文件≤30MB（可配置）

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|------|------|------|
| videoUrl | String | 是 | 视频链接或原始分享文本 ⭐优化5 | `【标题】 https://...` 或 `BV1xxx` |
| platform | String | 是 | 视频平台（枚举值）⭐优化2 | `BILIBILI` / `YOUTUBE` |

#### 请求示例（⭐支持原始分享文本）

**方式1：原始分享文本（推荐）** ⭐优化5
```json
{
  "videoUrl": "【【古风DJ】\"天青色等烟雨 而我在等你\"丨《青花瓷》DJ版（0.85x）】 https://www.bilibili.com/video/BV1RcUQBWEYN/?share_source=copy_web&vd_source=xxx",
  "platform": "BILIBILI"
}
```

**方式2：纯URL（向后兼容）**
```json
{
  "videoUrl": "https://www.bilibili.com/video/BV1RcUQBWEYN/?share_source=copy_web",
  "platform": "BILIBILI"
}
```

**方式3：纯BV号（向后兼容）**
```json
{
  "videoUrl": "BV1RcUQBWEYN",
  "platform": "BILIBILI"
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "musicId": null,
    "title": "【古风DJ】"天青色等烟雨 而我在等你"丨《青花瓷》DJ版（0.85x）",
    "audioUrl": "http://localhost:8910/temp-audio/BV1RcUQBWEYN.mp3",
    "coverUrl": "https://i0.hdslb.com/bfs/archive/xxx.jpg",
    "duration": 832,
    "fileSize": 26628831,
    "audioFormat": "mp3",
    "sourceVideoId": "BV1RcUQBWEYN"
  }
}
```

#### 前端交互流程（⭐简化操作）

```javascript
// ⭐优化5：用户直接粘贴B站分享内容，无需手动处理
const shareText = document.getElementById('videoUrl').value;  // 可能包含标题

// 2. 发起解析请求（后端自动提取URL）
fetch('/api/video/parse', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    videoUrl: shareText,  // ✅ 直接使用原始输入
    platform: 'BILIBILI'
  })
})
.then(response => response.json())
.then(data => {
  if (data.code === 200) {
    const result = data.data;
    // 显示解析结果
    showResult(result);
  }
});
```

---

## 🧪 测试计划（扩展）

### 功能测试清单

| 测试场景 | 测试步骤 | 预期结果 | 状态 |
|---------|---------|---------|------|
| **基础功能** | | | |
| B站视频解析 | 提交B站URL | 成功提取音频 | ✅ 已测试 |
| **⭐优化测试** | | | |
| 原始分享链接（优化5） | 粘贴`【标题】 https://...` | 自动提取URL并解析 | ✅ 已测试 |
| 纯URL（向后兼容） | 提交纯URL | 正常解析 | ✅ 已测试 |
| 配置文件大小（优化1） | 修改配置为50M | 限制自动更新 | ✅ 已测试 |
| 平台枚举（优化2） | 使用枚举值 | 类型安全，无拼写错误 | ✅ 已测试 |
| URL前缀配置（优化3） | 修改配置路径 | 访问路径自动更新 | ✅ 已测试 |
| 增强删除（优化4） | 文件被占用时清理 | 多次重试，详细日志 | ✅ 已测试 |
| **临时文件管理** | | | |
| 临时文件存储 | 解析视频后检查temp目录 | 文件存在于temp/目录 | ✅ 已测试 |
| 临时URL访问 | 访问返回的/temp-audio/xxx.mp3 | 可正常播放 | ✅ 已测试 |
| 定时清理任务 | 等待30分钟观察日志 | 日志显示清理任务执行 | ✅ 已测试 |
| 过期文件删除 | 创建2小时前的文件，运行清理 | 过期文件被删除 | ✅ 已测试 |

---

## ✅ 验收标准（扩展）

### 功能完整性
- [x] 用户可通过API提交B站视频链接
- [x] ⭐支持B站原始分享链接（包含标题）- 优化5
- [x] 系统成功提取MP3音频并存储到临时目录
- [x] 数据库正确创建music记录
- [x] 返回的临时audioUrl可正常播放
- [x] 临时文件1小时后自动删除
- [x] ⭐增强删除机制（Windows兼容）- 优化4
- [x] Windows和Linux环境均可正常运行
- [x] Swagger文档完整可用

### 异常处理
- [x] 文件大小>30MB时正确拦截（可配置）- 优化1
- [x] 存储容量不足时正确提示
- [x] 无效链接返回明确错误信息
- [x] 未实现的平台返回友好提示

### 代码质量 ⭐
- [x] 遵循SOLID原则和DRY原则（5轮优化）
- [x] 策略模式正确实现，易于扩展
- [x] ⭐消除所有魔法值（优化1、2、3）
- [x] ⭐类型安全（枚举代替字符串）- 优化2
- [x] 跨平台配置自动检测
- [x] 日志记录完整，便于排查问题

---

## 🎯 计划总结（更新）

本计划基于以下原则设计并完成：

1. **渐进式实现**: ✅ MVP已完成，后续5轮优化提升质量
2. **模块化设计**: ✅ 各模块职责清晰，易于维护和扩展
3. **策略模式**: ✅ 支持多平台扩展，无需修改核心代码
4. **跨平台支持**: ✅ 自动检测操作系统，适配Windows/Linux
5. **临时文件管理**: ✅ 避免存储空间浪费，提升系统可维护性
6. **代码规范**: ✅ 遵循项目现有规范（中文注释、分层架构）
7. **⭐代码优化**: ✅ 5轮优化，遵循SOLID全原则
8. **⭐用户体验**: ✅ 支持原始分享链接，简化操作流程
9. **文档先行**: ✅ 详细的计划和对接文档，确保开发顺利

**计划版本**: v3.0（优化版）
**创建时间**: 2026-01-30 22:17:08
**更新时间**: 2026-01-31 17:30:00
**计划状态**: ✅ 已完成（含5轮优化）

---

## 🔄 计划变更记录

| 时间 | 版本 | 变更内容 |
|------|------|---------|
| 2026-01-30 22:17:08 | v1.0 | 初始计划创建 |
| 2026-01-31 14:17:15 | v2.0 | 新增跨平台支持 + 临时文件管理优化 |
| 2026-01-31 17:30:00 | v3.0 | ⭐新增"已完成优化"章节，记录5轮代码优化 |

### v3.0 详细变更

1. **新增章节**: "已完成优化"，详细记录5轮优化过程
2. **更新状态**: 所有实施步骤标记为"已完成"
3. **优化标记**: 在相关章节添加⭐标记，指向对应优化
4. **配置更新**: application.yaml 反映所有优化后的配置
5. **测试更新**: 新增优化相关的测试用例
6. **验收标准**: 增加代码质量验收项（5轮优化）

---

## 📄 相关文档

### 优化文档（项目根目录）

以下文档记录了详细的优化过程，已整合到本计划文档中，可作为参考保留：

1. `代码重构总结-消除魔法值.md` - 优化1详细文档
2. `代码重构总结-消除平台魔法值.md` - 优化2详细文档
3. `代码重构总结-消除URL路径魔法值.md` - 优化3详细文档
4. `代码优化总结-增强文件删除机制.md` - 优化4详细文档
5. `代码优化总结-支持B站原始分享链接.md` - 优化5详细文档

**建议**: 优化文档可选择归档或删除，本计划文档已包含所有优化内容。

---

**下一步**: 功能已完成并优化，可进入生产部署阶段。

## 📌 备注

- 本文档持续更新，记录项目完整开发过程
- 所有优化均遵循SOLID原则和最佳实践
- 代码质量经过5轮优化，达到生产就绪状态
