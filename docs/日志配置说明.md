# 日志配置说明

## 📋 配置概览

项目已集成完整的 Logback 日志框架，支持多环境、多输出目标、自动滚动等功能。

### 配置文件

| 文件 | 路径 | 说明 |
|------|------|------|
| **logback-spring.xml** | `src/main/resources/logback-spring.xml` | 主日志配置文件 |
| **application.yaml** | `src/main/resources/application.yaml` | 日志级别配置 |

### 日志目录结构

```
wangyiyun-music/
├── logs/                                       # 日志根目录
│   ├── wangyiyun-music.log                    # 当前所有日志（未压缩）
│   ├── wangyiyun-music-error.log              # 当前错误日志（未压缩）
│   └── archive/                                # 历史日志归档（GZIP 压缩）
│       ├── wangyiyun-music-2026-01-31.0.log.gz       ← 压缩归档
│       └── wangyiyun-music-error-2026-01-31.0.log.gz ← 压缩归档
└── .gitignore                                  # 已配置忽略 logs/
```

---

## 🎯 日志级别配置

### 当前配置（application.yaml）

```yaml
logging:
  level:
    root: INFO                        # 根日志级别
    # Spring 框架日志（所有环境一致）
    org.springframework: INFO
    org.springframework.web: INFO
    # MyBatis 框架日志（所有环境一致）
    org.apache.ibatis: INFO
    # Druid 数据源日志（所有环境一致）
    com.alibaba.druid: INFO

  # 业务包日志级别由 logback-spring.xml 管理：
  # - 开发环境（dev）：mapper=DEBUG, service=DEBUG
  # - 生产环境（prod）：mapper=INFO, service=INFO
  # - 默认环境：mapper=DEBUG, service=INFO
```

**说明**：
- ✅ `application.yaml` 只配置框架级别的日志（不随环境变化）
- ✅ 业务包日志（mapper、service）由 `logback-spring.xml` 根据环境自动管理
- ✅ 临时调试可通过启动参数覆盖：`--logging.level.com.naruto.wangyiyunmusic.mapper=TRACE`

### 日志级别说明

| 级别 | 说明 | 使用场景 |
|------|------|---------|
| **TRACE** | 最详细的跟踪信息 | 深度调试 |
| **DEBUG** | 调试信息 | 开发环境、问题排查 |
| **INFO** | 重要业务流程信息 | 生产环境（推荐） |
| **WARN** | 警告信息（不影响运行） | 潜在问题提示 |
| **ERROR** | 错误信息 | 异常和错误 |

---

## 📁 日志输出目标

### 1. 控制台输出（CONSOLE）

- **输出级别**: 所有级别（由 logger 配置控制，包括 DEBUG）
- **格式**: `2026-01-31 21:53:00.123 [main] INFO  c.n.w.WangyiyunMusicApplication - 应用启动成功`
- **环境**: 开发环境、默认环境
- **说明**: 已移除 Appender 级别的过滤器，控制台可以输出 SQL 日志和 Service DEBUG 日志

### 2. 文件输出（FILE）

#### 所有日志文件
- **路径**: `./logs/wangyiyun-music.log`
- **滚动策略**:
  - 单文件最大 100MB
  - 按日期归档：`./logs/archive/wangyiyun-music-2026-01-31.0.log.gz` ⭐ **GZIP 压缩**
  - 保留 30 天
  - 总大小上限 10GB（压缩后的大小）
  - **压缩率**: 约 70-90%，大幅节省磁盘空间

#### 错误日志文件
- **路径**: `./logs/wangyiyun-music-error.log`
- **级别**: 仅 ERROR
- **滚动策略**:
  - 单文件最大 50MB
  - 按日期归档：`./logs/archive/wangyiyun-music-error-2026-01-31.0.log.gz` ⭐ **GZIP 压缩**
  - 保留 60 天

---

## 🌍 多环境配置

### 开发环境（dev）

```bash
# 启动命令
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 或在 application.yaml 中设置
spring:
  profiles:
    active: dev
```

**特点**:
- ✅ 控制台 + 文件双输出
- ✅ Mapper SQL 日志 DEBUG 级别
- ✅ Service 层包级别 INFO，重点服务（视频解析、音频服务等）DEBUG 级别
- ✅ 控制台可实时查看 SQL 日志和调试信息

### 生产环境（prod）

```bash
# 启动命令
java -jar wangyiyun-music.jar --spring.profiles.active=prod
```

**特点**:
- ✅ 仅文件输出（不输出到控制台）
- ✅ Mapper SQL 日志 INFO 级别
- ✅ 所有业务日志 INFO 级别

### 默认环境（无指定）

- ✅ 控制台 + 文件双输出
- ✅ Mapper SQL 日志 DEBUG 级别
- ✅ 适合本地开发测试

---

## 🧪 验证日志配置

### 步骤 1：启动应用

```bash
# 方式 1：Maven 启动
mvn spring-boot:run

# 方式 2：JAR 包启动
mvn clean package -DskipTests
java -jar target/wangyiyun-music-0.0.1-SNAPSHOT.jar
```

### 步骤 2：检查日志文件

```bash
# 检查日志目录
ls -lh logs/

# 查看当前日志
tail -f logs/wangyiyun-music.log

# 查看错误日志
tail -f logs/wangyiyun-music-error.log
```

### 步骤 3：验证日志内容

#### 预期控制台输出示例

**控制台可以看到 DEBUG 日志（包括 SQL）**：
```log
2026-01-31 21:53:00.123 [main] INFO  c.n.w.WangyiyunMusicApplication - Starting WangyiyunMusicApplication...
2026-01-31 21:53:00.456 [main] DEBUG c.n.w.mapper.MusicMapper - ==>  Preparing: SELECT * FROM music LIMIT 10
2026-01-31 21:53:00.789 [main] DEBUG c.n.w.mapper.MusicMapper - ==> Parameters:
2026-01-31 21:53:01.012 [main] DEBUG c.n.w.mapper.MusicMapper - <==      Total: 10
2026-01-31 21:53:01.456 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port(s): 8910 (http)
2026-01-31 21:53:01.789 [main] INFO  c.n.w.WangyiyunMusicApplication - Started WangyiyunMusicApplication in 2.5 seconds
```

#### 预期文件输出示例

`logs/wangyiyun-music.log`:
```log
2026-01-31 21:53:00.123 [main] INFO  c.n.w.WangyiyunMusicApplication - Starting WangyiyunMusicApplication...
2026-01-31 21:53:00.456 [main] DEBUG c.n.w.mapper.MusicMapper - ==>  Preparing: SELECT * FROM music LIMIT 10
2026-01-31 21:53:00.789 [main] DEBUG c.n.w.mapper.MusicMapper - ==> Parameters:
2026-01-31 21:53:01.012 [main] DEBUG c.n.w.mapper.MusicMapper - <==      Total: 10
```

---

## 🔧 自定义配置

### 调整日志级别

**临时修改（重启后失效）**:
```bash
# 启动时设置
java -jar wangyiyun-music.jar --logging.level.com.naruto.wangyiyunmusic=DEBUG
```

**永久修改**:

修改 `application.yaml`:
```yaml
logging:
  level:
    # 将某个包的日志级别改为 TRACE
    com.naruto.wangyiyunmusic.service.impl.VideoParseServiceImpl: TRACE
```

### 调整文件大小限制

修改 `logback-spring.xml`:
```xml
<!-- 修改单文件最大大小 -->
<maxFileSize>200MB</maxFileSize>  <!-- 从 100MB 改为 200MB -->

<!-- 修改保留天数 -->
<maxHistory>60</maxHistory>  <!-- 从 30 天改为 60 天 -->

<!-- 修改总大小上限 -->
<totalSizeCap>20GB</totalSizeCap>  <!-- 从 10GB 改为 20GB -->
```

### 关闭 Mapper SQL 日志

**方式 1：修改 logback-spring.xml（推荐）**
```xml
<!-- 修改开发环境配置 -->
<springProfile name="dev">
    <logger name="com.naruto.wangyiyunmusic.mapper" level="INFO"/>  <!-- 从 DEBUG 改为 INFO -->
</springProfile>
```

**方式 2：临时关闭（启动参数）**
```bash
# 启动时设置为 INFO
java -jar wangyiyun-music.jar --logging.level.com.naruto.wangyiyunmusic.mapper=INFO
```

**方式 2：修改 MyBatis-Plus 配置**
```yaml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.nologging.NoLoggingImpl  # 完全关闭
```

---

## 📊 日志示例

### 业务日志示例

```java
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class MusicServiceImpl implements MusicService {

    @Override
    public Music getMusicById(Long id) {
        log.info("查询音乐详情, musicId: {}", id);  // INFO 级别

        Music music = musicMapper.selectById(id);

        if (music == null) {
            log.warn("音乐不存在, musicId: {}", id);  // WARN 级别
            throw new BusinessException("音乐不存在");
        }

        log.debug("音乐详情查询成功: {}", music);  // DEBUG 级别
        return music;
    }
}
```

### 异常日志示例

```java
try {
    // 业务逻辑
} catch (Exception e) {
    log.error("视频解析失败, videoUrl: {}, 错误信息: {}", videoUrl, e.getMessage(), e);
    throw new VideoParseException("视频解析失败", e);
}
```

---

## 🎨 日志输出格式

### 当前格式

```
%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n
```

### 格式说明

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `%d{...}` | 日期时间 | `2026-01-31 21:53:00.123` |
| `[%thread]` | 线程名 | `[http-nio-8910-exec-1]` |
| `%-5level` | 日志级别（左对齐5字符） | `INFO ` |
| `%logger{50}` | Logger 名称（最多50字符） | `c.n.w.service.impl.MusicServiceImpl` |
| `%msg` | 日志消息 | `查询音乐详情, musicId: 123` |
| `%n` | 换行符 | - |

---

## ⚠️ 注意事项

### 1. 日志文件不提交到 Git

`.gitignore` 已配置：
```gitignore
### Logs ###
logs/
*.log
*.log.*
```

### 2. 生产环境日志管理

- ✅ 定期检查 `logs/archive/` 目录大小
- ✅ 配置日志收集工具（如 ELK、Splunk）
- ✅ 关注 `wangyiyun-music-error.log` 错误日志

### 3. 性能考虑

- ⚠️ 避免在循环中使用 DEBUG 日志
- ⚠️ 使用参数化日志：`log.info("用户ID: {}", userId)` 而非 `log.info("用户ID: " + userId)`
- ⚠️ 生产环境建议关闭 DEBUG 级别日志

### 4. 日志安全

- ❌ 不要记录敏感信息（密码、Token、身份证号等）
- ✅ 脱敏处理：`log.info("手机号: {}", PhoneUtil.mask(phone))`

---

## 📂 查看压缩日志

归档日志使用 GZIP 压缩（`.gz` 后缀），查看方法如下：

### Windows 环境

#### 方法 1：使用 7-Zip / WinRAR
- 双击 `.gz` 文件，使用 7-Zip 或 WinRAR 解压
- 或右键 → 解压到当前文件夹

#### 方法 2：使用 Git Bash
```bash
# 查看压缩日志内容（不解压）
zcat logs/archive/wangyiyun-music-2026-01-31.0.log.gz | less

# 搜索关键字
zcat logs/archive/wangyiyun-music-2026-01-31.0.log.gz | grep "ERROR"

# 查看前 100 行
zcat logs/archive/wangyiyun-music-2026-01-31.0.log.gz | head -100
```

### Linux 环境

```bash
# 方法 1：直接查看（推荐）
zcat logs/archive/wangyiyun-music-2026-01-31.0.log.gz | less

# 方法 2：搜索关键字
zgrep "ERROR" logs/archive/wangyiyun-music-2026-01-31.0.log.gz

# 方法 3：查看最后 100 行
zcat logs/archive/wangyiyun-music-2026-01-31.0.log.gz | tail -100

# 方法 4：解压后查看
gunzip logs/archive/wangyiyun-music-2026-01-31.0.log.gz
# 会解压为 wangyiyun-music-2026-01-31.0.log

# 方法 5：解压但保留 .gz 文件
gunzip -k logs/archive/wangyiyun-music-2026-01-31.0.log.gz
```

---

## 🎯 日志级别控制：Logger vs Appender Filter

### Logger 配置（推荐）✅

**由 `<logger>` 标签控制日志级别**，这是日志级别控制的正确方式：

```xml
<!-- 推荐：通过 Logger 配置控制 -->
<logger name="com.naruto.wangyiyunmusic.mapper" level="DEBUG"/>        <!-- 输出 DEBUG -->
<logger name="com.naruto.wangyiyunmusic.service" level="INFO"/>        <!-- 输出 INFO -->

<!-- Appender 不过滤，让 Logger 决定 -->
<appender name="CONSOLE">
    <!-- 无过滤器 -->
</appender>
```

**优点**：
- ✅ 配置清晰，易于理解
- ✅ 细粒度控制（每个包/类独立配置）
- ✅ 多环境配置灵活（dev/prod 分离）

### Appender Filter（不推荐用于日志级别控制）⚠️

**由 Appender 过滤器控制**，会导致配置冲突：

```xml
<!-- ❌ 不推荐：会导致配置混乱 -->
<logger name="com.naruto.wangyiyunmusic.mapper" level="DEBUG"/>  <!-- 想输出 DEBUG -->

<appender name="CONSOLE">
    <!-- ❌ 但被 Filter 拦截了 -->
    <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
        <level>INFO</level>
    </filter>
</appender>
```

**问题**：
- ❌ Logger 配置被 Appender 过滤器覆盖
- ❌ 控制台看不到 DEBUG 日志
- ❌ 配置意图不明确

### Appender Filter 的正确使用场景

仅用于**特殊场景**，如错误日志分离：

```xml
<!-- ✅ 正确使用：只记录 ERROR 级别到错误日志文件 -->
<appender name="ERROR_FILE">
    <filter class="ch.qos.logback.classic.filter.LevelFilter">
        <level>ERROR</level>
        <onMatch>ACCEPT</onMatch>
        <onMismatch>DENY</onMismatch>
    </filter>
</appender>
```

---

## 📚 相关文档

- [Logback 官方文档](http://logback.qos.ch/documentation.html)
- [Spring Boot 日志文档](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.logging)
- [阿里巴巴 Java 开发手册 - 日志规约](https://github.com/alibaba/p3c)

---

## 🔄 版本历史

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2026-01-31 | v1.0 | 初始版本，集成 Logback 日志框架 |
| 2026-01-31 | v1.1 | 优化日志配置：启用 GZIP 压缩、移除控制台过滤器、优化配置分层 |

### v1.1 详细变更（2026-01-31）

#### 1. 启用 GZIP 压缩归档日志 ⭐
- ✅ 归档日志使用 `.log.gz` 后缀，自动 GZIP 压缩
- ✅ 压缩率 70-90%，大幅节省磁盘空间
- ✅ 10GB 上限可存储更多历史日志（实际可保留 100-300 天）

#### 2. 移除控制台 Appender 过滤器 ⭐
- ✅ 控制台可以输出 DEBUG 日志（包括 SQL 日志）
- ✅ 方便开发调试，无需频繁查看日志文件
- ✅ 日志级别完全由 `<logger>` 配置控制，配置更清晰

#### 3. 优化 application.yaml 配置分层 ⭐
- ✅ 移除业务包日志配置，避免与 `logback-spring.xml` 冲突
- ✅ 只保留框架级别的日志配置（Spring、MyBatis、Druid）
- ✅ 业务包日志由 `logback-spring.xml` 根据环境自动管理

#### 4. 明确 Service 包级别配置 ⭐
- ✅ 添加 `<logger name="com.naruto.wangyiyunmusic.service" level="INFO"/>`
- ✅ 重点服务（视频解析、音频服务等）单独提升到 DEBUG
- ✅ 配置意图更清晰，新增 Service 自动继承 INFO 级别

#### 5. 更新文档说明
- ✅ 添加 GZIP 压缩日志查看方法（Windows/Linux）
- ✅ 添加 Logger vs Appender Filter 的详细说明
- ✅ 更新所有示例和配置说明

---

**文档维护者**: naruto
**最后更新**: 2026-01-31 23:00
